<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Publish Edge Images on Remote OSTree Repositories :: Building Red Hat Device Edge Images</title>
    <link rel="prev" href="s2-ostree-lab.html">
    <link rel="next" href="s4-summary.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Building Red Hat Device Edge Images</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/rhde-build/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="rhde-build" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Building Red Hat Device Edge Images</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch1-build/index.html">Build Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s1-devices.html">Introduction to Red Hat Device Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s2-devices-quiz.html">Quiz: Use Cases for Edge Devices and RHEL for Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s3-images.html">Design, Build, and Publish Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s4-install-lab.html">Lab: Install Image Builder on a Development Machine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s5-blueprint.html">Create and Manage Blueprints for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s6-blueprint-lab.html">Lab: Create and Manage Blueprints for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s7-compose.html">Create Edge Images as Image Builder Composes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s8-compose-lab.html">Lab: Create and Manage Composes for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s9-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Publish Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s1-ostree.html">Introduction to OSTree Technology</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s2-ostree-lab.html">Lab: Create a Remote OSTree Repository</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="s3-pull-local-lab.html">Lab: Publish Edge Images on Remote OSTree Repositories</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s4-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch3-test/index.html">Test Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s1-boot.html">Validate and Test Edge Images Using Virtual Machines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s2-boot-lab.html">Lab: Boot Test VMs from Remote OSTree Repositories</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s3-installer-lab.html">Lab: Boot Test VMs from Edge Installer Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s5-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch4-update/index.html">Update Edge Devices with New Operating System Images</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch4-update/s1-deltas.html">Apply, and Rollback Updates to Edge Devices</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch4-update/s2-update-lab.html">Lab: Create And Publish Edge Image Updates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch4-update/s3-rollback-lab.html">Lab: Rollback Edge Image Updates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch4-update/s4-deltas-lab.html">Lab: Update Edge Devices Using Static Deltas</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch4-update/s5-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Building Red Hat Device Edge Images</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Building Red Hat Device Edge Images</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../samples/1/index.html">samples</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../samples/1/index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Building Red Hat Device Edge Images</a></li>
    <li><a href="index.html">Publish Operating System Images for Edge Devices</a></li>
    <li><a href="s3-pull-local-lab.html">Lab: Publish Edge Images on Remote OSTree Repositories</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Publish Edge Images on Remote OSTree Repositories</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Estimated reading time: <strong>6 minutes</strong>.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Objective</dt>
<dd>
<p>Publish an edge commit image from Image Builder  in an existing remote OSTree repository so it is available to edge devices.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_you_begin"><a class="anchor" href="#_before_you_begin"></a>Before you Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need a <em>development machine</em> with RHEL and configured with the Image Builder service, its CLI and web UI, and a user that is member of the <code>weldr</code> group. Make sure your test machine was configured and verified by following the instructions from the <a href="../ch1-build/s4-install-lab.html" class="xref page">first lab</a>.</p>
</div>
<div class="paragraph">
<p>You also need a <em>web server machine</em> which serves an OSTree repository. Make sure you web server was configured and verified by following the instructions from the <a href="s2-ostree-lab.html" class="xref page">previous lab</a>.</p>
</div>
<div class="paragraph">
<p>These instructions were tested on RHEL 9.4 [tentative!] but should work with minimal or no change on and newer and older RHEL 9.x releases.</p>
</div>
<div class="paragraph">
<p>If you are using the course classroom, you will log in on the <code>workstation</code> VM as the user <code>student</code> with password <code>student</code>, and you will start SSH sessions to the <code>servera</code> VM from the same user. If not, please adapt the instructions to your test environment.</p>
</div>
<div class="paragraph">
<p>You will perform some steps of this lab on your <em>development machine</em> and some steps on your <em>web server machine</em>. Pay attention to the instructions at each step!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instructions"><a class="anchor" href="#_instructions"></a>Instructions</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On your <em>development machine</em>, verify that you have the prerequisites from previous labs.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Verify that the Image Builder service is active and that the current Linux user can submit requests to it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli status show</strong>
API server status:
    Database version:   0
    Database supported: true
    Schema version:     0
    API version:        1
    Backend:            osbuild-composer
    Build:              NEVRA:osbuild-composer-76-2.el9_2.x86_64
...</code></pre>
</div>
</div>
</li>
<li>
<p>Check that a remote client can access the OSTree repository in the web server machine.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com/repo/config</strong>
[core]
repo_version=1
mode=archive-z2</code></pre>
</div>
</div>
</li>
<li>
<p>Open a web browser and navigate to the path <code>/repo/refs/heads</code> of the web server. This directory tree lists all branches of an OSTree repository. You should see a branch with the path <code>rhel/9/x86_64/edge</code>.</p>
<div class="paragraph">
<p>Alternatively, fetch the current commit ID of that branch from the command line. Your will get a different ID:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com/repo/refs/heads/rhel/9/x86_64/edge</strong>
7ff678881e89e96c90eb083b905dce411740caf19c524481d7c1b848647b5746</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that the commit ID of an edge image in an OSTree repository does <strong>not</strong> match its UUID in the Image Builder service.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Still on your <em>development machine</em>, get a blueprint to build a second edge system image, running a different application than the image used in previous exercises. The first image runs an Apache Web Server, and this second image runs a MySQL database.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Download the <code>rhel9-mysql.toml</code> blueprint file from the <a href="https://github.com/RedHatQuickCourses/rhde-build-samples/tree/main">course samples</a> git repository.</p>
</li>
<li>
<p>Review the blueprint, it just installs and enables a MySQL server, which is uninitialized.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>less rhel9-mysql.toml</strong>
name = "rhel9-mysql"
description = "an edge database server"
version = "0.1.0"
modules = []
groups = []
distro = ""

[[packages]]
name = "mysql-server"

[customizations]
hostname = "db"

[customizations.services]
enabled = ["sshd", "mysqld"]

[customizations.firewall.services]
enabled = ["ssh", "mysql"]
...</code></pre>
</div>
</div>
</li>
<li>
<p>Push the blueprint to the Image Builder service, and verify that both the first blueprint, from <a href="../ch1-build/s6-blueprint-lab.html" class="xref page">a previous lab</a>, and the second blueprint are available.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli blueprints push rhel9-mysql.toml</strong>
$ <strong>composer-cli blueprints list</strong>
rhel9-edge
rhel9-mysql</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Again on your <em>development machine</em>, build an edge commit image from the MySQL bluerprint.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Create a compose from the second blueprint, but specify a different OSTree branch name for this compose, using the <code>--ref</code> option, else it will be considered by edge devices just another version of the first image, instead of a different image.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose start-ostree rhel9-mysql edge-commit --ref rhel/9/x86_64/db</strong>
Compose ff15f8cd-21da-489a-87d0-bb39df4b79ad added to the queue.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that the UUID of the compose will be different for you.</p>
</div>
</li>
<li>
<p>To ease the following steps, copy and paste the UUID of the compose, from the output of the previous command, to a shell variable.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>UUID=<em>ff15f8cd-21da-489a-87d0-bb39df4b79ad</em></strong></code></pre>
</div>
</div>
</li>
<li>
<p>Wait until your compose has finished successfully. You may need to repeat the following command multiple times.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose list</strong>
ID                                     Status     Blueprint         Version   Type
ff15f8cd-21da-489a-87d0-bb39df4b79ad   RUNNING    rhel9-mysql       0.0.1     edge-commit
...
$ <strong>composer-cli compose list</strong>
ID                                     Status     Blueprint         Version   Type
ff15f8cd-21da-489a-87d0-bb39df4b79ad   FINISHED   rhel9-mysql       0.0.1     edge-commit
...</code></pre>
</div>
</div>
</li>
<li>
<p>Download the edge commit image from your compose.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose image $UUID</strong>
ff15f8cd-21da-489a-87d0-bb39df4b79ad-commit.tar</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the edge commit image to your home directory on the web server machine.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>scp $UUID-commit.tar servera.lab.example.com:~</strong>
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Switch to your <em>web server machine</em> and publish the edge commit image on its OSTree repository.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>On another terminal, start an SSH session on your web server machine (<code>servera</code>), and copy the shell variable from the first terminal.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ssh servera</strong>
$ <strong>UUID=<em>ff15f8cd-21da-489a-87d0-bb39df4b79ad</em></strong></code></pre>
</div>
</div>
</li>
<li>
<p>Extract the edge commit image to a temporary directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>mkdir delete-me</strong>
$ <strong>sudo tar xf ~/$UUID-commit.tar -C delete-me</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Before proceeding, ensure your new edge commit image uses a different branch name than the edge commit image that&#8217;s already in the OSTree repository of the web server.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree --repo=delete-me/repo refs</strong>
rhel/9/x86_64/db
$ <strong>ostree --repo=/var/www/html/repo refs</strong>
rhel/9/x86_64/edge</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the edge commit image to the web server by pulling from the OSTree repository in the temporary directory to the OSTree repository in web server document root. Notice that you need root privileges to write to web server files.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo ostree pull-local --repo=/var/www/html/repo delete-me/repo</strong>
446 metadata, 1574 content objects imported; 0 bytes content written</code></pre>
</div>
</div>
</li>
<li>
<p>Check that now there are two edge images (two branches) on the OSTree repository on the web server.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree refs --repo=/var/www/html/repo</strong>
rhel/9/x86_64/edge
rhel/9/x86_64/db</code></pre>
</div>
</div>
</li>
<li>
<p>You can now delete the temporary directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>rm -rf delete-me</strong></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Back to your <em>development machine</em>, verify that a remote client can fetch the new edge commit image from the web server by checking that you can fetch the commit ID of the new OSTree branch.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com/repo/refs/heads/rhel/9/x86_64/db</strong>
12a22681baff58184e22ebc3e189453ed18f0984727c81311781021ccab899a1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your commit ID will be different than the one above.</p>
</div>
</li>
<li>
<p>If you wish, you can now close the SSH connection to the web server machine and its terminal.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now you have a web server configured to serve an OSTree repository with contains two different edge system images.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps"><a class="anchor" href="#_next_steps"></a>Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The next activity will provision local VMs from the two edge system images, using either the standard RHEL installation media or a customized edge installer image.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="s2-ostree-lab.html">Lab: Create a Remote OSTree Repository</a></span>
  <span class="next"><a href="s4-summary.html">Summary</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
