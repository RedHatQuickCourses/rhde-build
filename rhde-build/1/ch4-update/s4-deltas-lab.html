<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Update Edge Devices Using Static Deltas :: Building Red Hat Device Edge Images</title>
    <link rel="prev" href="s3-rollback-lab.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Building Red Hat Device Edge Images</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/rhde-build/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="rhde-build" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Building Red Hat Device Edge Images</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch1-build/index.html">Build Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s1-devices.html">Introduction to Red Hat Device Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s2-devices-quiz.html">Quiz: Use Cases for Edge Devices and RHEL for Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s3-images.html">Design, Build, and Publish Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s4-install-lab.html">Lab: Install Image Builder on a Development VM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s5-blueprint.html">Create and Manage Blueprints for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s6-blueprint-lab.html">Lab: Create and Manage Blueprints for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s7-compose.html">Create Edge Images as Image Builder Composes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s8-compose-lab.html">Lab: Create and Manage Composes for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s9-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch2-publish/index.html">Publish Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-publish/s1-ostree.html">Introduction to OSTree Technology</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-publish/s2-ostree-lab.html">Lab: Create a Remote OSTree Repository</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-publish/s3-pull-local-lab.html">Lab: Publish Edge Images on Remote OSTree Repositories</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-publish/s4-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch3-test/index.html">Test Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s1-boot.html">Validate and Test Edge Images Using Virtual Machines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s2-boot-lab.html">Lab: Boot Test VMs from Remote OSTree Repostories</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s3-installer-lab.html">Lab: Boot Test VMs from Edge Installer Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s5-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Update Edge Devices with New Operating System Images</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s1-deltas.html">Apply, and Rollback Updates to Edge Devices</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s2-update-lab.html">Lab: Create And Publish Edge Image Updates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s3-rollback-lab.html">Lab: Rollback Edge Image Updates</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="s4-deltas-lab.html">Lab: Update Edge Devices Using Static Deltas</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Building Red Hat Device Edge Images</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Building Red Hat Device Edge Images</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Building Red Hat Device Edge Images</a></li>
    <li><a href="index.html">Update Edge Devices with New Operating System Images</a></li>
    <li><a href="s4-deltas-lab.html">Lab: Update Edge Devices Using Static Deltas</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Update Edge Devices Using Static Deltas</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Estimated reading time: <strong>11 minutes</strong>.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Objective</dt>
<dd>
<p>Update a test VM, that was provisioned using an edge installer image, using OSTree deltas.</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Work in Progress
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_you_begin"><a class="anchor" href="#_before_you_begin"></a>Before you Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need a <em>development machine</em> with RHEL and configured with the Image Builder service, its CLI and web UI, and a user that is member of the <code>weldr</code> group. Make sure your development machine was configured and verified by following the instructions from the <a href="../ch1-build/s4-install-lab.html" class="xref page">first lab</a>.</p>
</div>
<div class="paragraph">
<p>You also need a <em>web server machine</em> which serves an OSTree repository. Make sure that machine was configured and verified by following the instructions from <a href="../ch2-publish/s2-ostree-lab.html" class="xref page">a previous lab</a>.</p>
</div>
<div class="paragraph">
<p>Finally, you need the <em>test VM</em> that you created and published in <a href="#ch2-publish:s2-boot-lab.adoc" class="xref unresolved">another lab</a>.</p>
</div>
<div class="paragraph">
<p>These instructions were tested on RHEL 9.4 [tentative!] but should work with minimal or no change on and newer and older RHEL 9.x releases.</p>
</div>
<div class="paragraph">
<p>If you are using the course classroom, you will log in on the <code>workstation</code> VM as the user <code>student</code> with password <code>student</code>, and you start SSH sessions to the <code>servera</code> VM from the same user. In this case, the <code>workstation</code> VM is your <em>development machine</em>, and the <code>servera</code> VM is your <em>web server</em> machine. If not, please adapt the instructions to your test environment.</p>
</div>
<div class="paragraph">
<p>[ REVIEW NEXT PARA ]</p>
</div>
<div class="paragraph">
<p>You will some steps in this lab on your <em>development machine</em> and some steps on the <em>web server</em> machine.</p>
</div>
<div class="paragraph">
<p>[ Make one lab perform an update without a delta, and the other with a delta? ]</p>
</div>
<div class="paragraph">
<p>[ Add commands to start VMs and connect to their consoles ]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instructions"><a class="anchor" href="#_instructions"></a>Instructions</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On your <em>development machine</em>, verify that you have the prerequisites from previous labs.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Verify that the Image Builder service is active and that the current Linux user can submit requests to it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli status show</strong>
API server status:
    Database version:   0
    Database supported: true
    Schema version:     0
    API version:        1
    Backend:            osbuild-composer
    Build:              NEVRA:osbuild-composer-76-2.el9_2.x86_64
...</code></pre>
</div>
</div>
</li>
<li>
<p>Check that a remote client can access the OSTree repository in the web server machine.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com/repo/config</strong>
[core]
repo_version=1
mode=archive-z2</code></pre>
</div>
</div>
</li>
<li>
<p>Check that you can get the current commit ID the OSTree branch with the httpd edge system image that you created in <a href="#ch2-publish:s3-ostree-lab.adoc" class="xref unresolved">a previous lab</a>. Your will get a different ID:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com/repo/refs/heads/rhel/9/x86_64/edge</strong>
4afeda6a96ec8b2c263b6965a9c3f92db1db2436ae1e1233da70b7776fc6137b</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pay attention to the final path element of the URL, which should be "edge".</p>
</div>
</li>
<li>
<p>Check that you can manage local VMs, and there&#8217;s a VM left from the <a href="#s2-boot-lab:">previous lab</a> named <code>edge-test-1</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>virsh list --all</strong>
 Id   Name          State
---------------------------
 1    edge-test-1   shut-off
 2    edge-db-1     shut-off
---
+
It's fine the existing VM displays an status of "running" instead of "shut off".

2. Make changes to the edge image blueprint to add a custom welcome page to the Apache Web Server.

.. Open the <code>rhel9-httpd.toml</code> file which you created in a xref:ch1-build-blueprint-lab.adoc[previous lab], with any text editor.

.. Increment the version number, in tbe beginning of the TOML file, and add a <code>customizations.file</code> section with an inline HTML page, to the end of the TOML file.
+
[ didn't work, switch to adding the cockpit package ]
+
[source,subs="verbatim,quotes"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>name = "rhel9-edge"
description = "blueprint-rhel9-edge"
version = "0.0.2"
&#8230;&#8203;</p>
</div>
<div id="customizations.files" class="paragraph">
<p>path = "/var/www/html/index.html"
mode = "0644"
user = "root"
group = "root"
data = """
&lt;html&gt;
&lt;body&gt;
&lt;h1&gt;I am an Edge Device!&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
"""--</p>
</div>
</li>
<li>
<p>Push the updated blueprint.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli push blueprints rhde-build-samples/blueprints/rhel9-httpd-v2.toml</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the blueprint in the Image Builder service contains your changes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli blueprints list</strong>
mysql-installer
rhel9-edge
rhel9-mysql
$ <strong>composer-cli blueprints show rhel9-edge</strong>
name = "rhel9-edge"
description = "blueprint-rhel9-edge"
version = "0.0.2"
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Still on your <em>development machine</em>, build an edge commit image from your changed blueprint.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Start a compose for an edge commit image and copy its UUID to a shell variable.</p>
<div class="paragraph">
<p>[ do I need a parent? looks like I have to reference the external repo ]</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose start-ostree rhel9-edge edge-commit --url http://servera.lab.example.com/repo --ref rhel/9/x86_64/edge</strong>
Compose fb5ef664-1def-4589-919d-1a0681f86371 added to the queue
$ <strong>UUID=fb5ef664-1def-4589-919d-1a0681f86371</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Wait until the compose finishes. To avoid clutter from previous labs, this time we filter the list of composes.</p>
<div class="paragraph">
<p>[ try a better filter with jq. why can&#8217;t I ask just the status of a given compose? :-() ]</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose list running</strong>
ID                                     Status    Blueprint    Version   Type
fb5ef664-1def-4589-919d-1a0681f86371   RUNNING   rhel9-edge   0.0.2     edge-commit
$ <strong>composer-cli compose list running</strong>
ID   Status   Blueprint   Version   Type
$ <strong>composer-cli compose list finished</strong>
ID                                     Status     Blueprint     Version   Type
...
fb5ef664-1def-4589-919d-1a0681f86371   FINISHED   rhel9-edge    0.0.2     edge-commit</code></pre>
</div>
</div>
</li>
<li>
<p>Download the edge commit image and copy it to your <em>web sever machine</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose image $UUID</strong>
fb5ef664-1def-4589-919d-1a0681f86371-commit.tar
$ <strong>scp $UUID-commit.tar servera:~</strong>
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On your <em>web server machine</em>, copy the new edge image to the OSTree repository.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Copy the shell variable with the UUID of the new edge commit image and check that it exists on your home folder.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>UUID=fb5ef664-1def-4589-919d-1a0681f86371</strong>
$ <strong>ls $UUID-commit.tar</strong>
fb5ef664-1def-4589-919d-1a0681f86371-commit.tar</code></pre>
</div>
</div>
</li>
<li>
<p>Extract the edge commit image and pull it into the OSTree repository.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>mkdir delete-me</strong>
$ <strong>tar xf $UUID-commit.tar -C delete-me/</strong>
$ <strong>sudo ostree pull-local --repo=/var/www/html/repo delete-me/repo</strong>
506 metadata, 1893 content objects imported; 0 bytes content written</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the OSTree repo contains the same branch than your new edge commit image. The OSTree repo should contain additional branches.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree refs --repo=delete-me/repo</strong>
rhel/9/x86_64/edge
$ <strong>ostree refs --repo=/var/www/html/repo</strong>
rhel/9/x86_64/edge
rhel/9/x86_64/db</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the OSTree repo contains the same commit than your new edge commit image.</p>
<div class="paragraph">
<p>[ looks like my pull overwrote everything in the branch with the new commit and discarded the old one :-( ]</p>
</div>
<div class="paragraph">
<p>[ do I fix this at build time or at pull time? looks like at build time ]</p>
</div>
<div class="paragraph">
<p>[ parent must be 4afeda6a96ec8b2c263b6965a9c3f92db1db2436ae1e1233da70b7776fc6137b for consistency with previous labs ]</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree log rhel/9/x86_64/edge --repo=delete-me/repo</strong>
commit 4caef3752842366bbeab77b57b79854c6cb7bf4f2b62e82190cfba5d1cc3c12b
Parent:  7ff678881e89e96c90eb083b905dce411740caf19c524481d7c1b848647b5746
ContentChecksum:  94e275f4f9c9a9f68426ed9421845a48065467aea8bfcb57d826ed43fa50a253
Date:  2024-10-09 22:43:27 +0000
Version: 9.2
(no subject)

&lt;&lt; History beyond this commit not fetched &gt;&gt;
$ <strong>ostree log rhel/9/x86_64/edge --repo=/var/www/html/repo</strong>
commit 4caef3752842366bbeab77b57b79854c6cb7bf4f2b62e82190cfba5d1cc3c12b
Parent:  7ff678881e89e96c90eb083b905dce411740caf19c524481d7c1b848647b5746
ContentChecksum:  94e275f4f9c9a9f68426ed9421845a48065467aea8bfcb57d826ed43fa50a253
Date:  2024-10-09 22:43:27 +0000
Version: 9.2
(no subject)

commit 7ff678881e89e96c90eb083b905dce411740caf19c524481d7c1b848647b5746
ContentChecksum:  f938c449602ad38c31a74bd35f0e438beb833e8ca592c07c87ef90a56f659586
Date:  2024-10-09 20:25:03 +0000
Version: 9.2
(no subject)</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Now how do I get and apply the update to the test VM?</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@edge ~]$  rpm-ostree status
State: idle
Deployments:
● edge:rhel/9/x86_64/edge
                  Version: 9.2 (2024-10-09T20:25:03Z)
                   Commit: 7ff678881e89e96c90eb083b905dce411740caf19c524481d7c1b848647b5746
[core@edge ~]$ sudo rpm-ostree upgrade --check
2 metadata, 0 content objects fetched; 18 KiB transferred in 0 seconds; 0 bytes content written
Note: --check and --preview may be unreliable.  See https://github.com/coreos/rpm-ostree/issues/1579
AvailableUpdate:
        Version: 9.2 (2024-10-09T22:43:27Z)
         Commit: 4caef3752842366bbeab77b57b79854c6cb7bf4f2b62e82190cfba5d1cc3c12b
           Diff: 46 added
[core@edge ~]$ sudo rpm-ostree upgrade
[ 9130.645481] SELinux:  Context system_u:object_r:cockpit_ws_exec_t:s0 is not valid (left unmapped).
[ 9130.658824] SELinux:  Context system_u:object_r:cockpit_session_exec_t:s0 is not valid (left unmapped).
[ 9131.532015] SELinux:  Context system_u:object_r:cockpit_unit_file_t:s0 is not valid (left unmapped).
⠴ Receiving objects; 66% (1605/2400) 58.1 MB/s 116.3 MB                         507 metadata, 1893 content objects fetched; 118645 KiB transferred in 3 seconds; 187.9 MB content written
Receiving objects; 66% (1605/2400) 58.1 MB/s 116.3 MB... done
Staging deployment... done
Added:
  adobe-source-code-pro-fonts-2.030.1.050-12.el9.1.noarch
  cockpit-286.1-1.el9.x86_64
...
Run "systemctl reboot" to start a reboot
$ systemctl reboot
...
boot messages
...
new login
...
[core@edge ~]$ rpm-ostree status
State: idle
Deployments:
● edge:rhel/9/x86_64/edge
                  Version: 9.2 (2024-10-09T22:43:27Z)
                   Commit: 4caef3752842366bbeab77b57b79854c6cb7bf4f2b62e82190cfba5d1cc3c12b

  edge:rhel/9/x86_64/edge
                  Version: 9.2 (2024-10-09T20:25:03Z)
                   Commit: 7ff678881e89e96c90eb083b905dce411740caf19c524481d7c1b848647b5746

[core@edge ~]$ ostree log rhel/9/x86_64/edge
commit 4caef3752842366bbeab77b57b79854c6cb7bf4f2b62e82190cfba5d1cc3c12b
Parent:  7ff678881e89e96c90eb083b905dce411740caf19c524481d7c1b848647b5746
ContentChecksum:  94e275f4f9c9a9f68426ed9421845a48065467aea8bfcb57d826ed43fa50a253
Date:  2024-10-09 22:43:27 +0000
Version: 9.2
(no subject)

commit 7ff678881e89e96c90eb083b905dce411740caf19c524481d7c1b848647b5746
ContentChecksum:  f938c449602ad38c31a74bd35f0e438beb833e8ca592c07c87ef90a56f659586
Date:  2024-10-09 20:25:03 +0000
Version: 9.2
(no subject)

[core@edge ~]$ rpm -q cockpit
cockpit-286.1-1.el9.x86_64</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the bullet on rpm-ostree status to show which is the active deployment</p>
</div>
<div class="paragraph">
<p>[ do static detlas now or later? ]</p>
</div>
<div class="paragraph">
<p>[ I didn&#8217;t do "ostreee summary -u"  what is its purpose? ]</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Info om remotes depends on summary files on server</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@edge ~]$ ostree remote refs edge
error: Remote refs not available; server has no summary file

after [student@servera ~]$ sudo ostree summary -u --repo=/var/www/html/repo

[core@edge ~]$ ostree remote refs edge
edge:rhel/9/x86_64/edge</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Build another update and pull to the ostree repo</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Have three commits in the branch.</p>
<div class="paragraph">
<p>[ any way of setting the subject during a pull local? or at image build time? ]</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[student@servera ~]$ ostree refs --repo /var/www/html/repo
rhel/9/x86_64/edge
[student@servera ~]$ ostree log rhel/9/x86_64/edge --repo /var/www/html/repo
commit cfd48bbd633b68844c4ca8122f26e5fa36d8aad929525c61331d0aab5c3d3e88
Parent:  4caef3752842366bbeab77b57b79854c6cb7bf4f2b62e82190cfba5d1cc3c12b
ContentChecksum:  a366c9c7b9887f26356db475c62aee3197ccdb505fe90406b391b11b049e47d0
Date:  2024-10-10 16:37:33 +0000
Version: 9.2
(no subject)

commit 4caef3752842366bbeab77b57b79854c6cb7bf4f2b62e82190cfba5d1cc3c12b
Parent:  7ff678881e89e96c90eb083b905dce411740caf19c524481d7c1b848647b5746
ContentChecksum:  94e275f4f9c9a9f68426ed9421845a48065467aea8bfcb57d826ed43fa50a253
Date:  2024-10-09 22:43:27 +0000
Version: 9.2
(no subject)

commit 7ff678881e89e96c90eb083b905dce411740caf19c524481d7c1b848647b5746
ContentChecksum:  f938c449602ad38c31a74bd35f0e438beb833e8ca592c07c87ef90a56f659586
Date:  2024-10-09 20:25:03 +0000
Version: 9.2
(no subject)</code></pre>
</div>
</div>
</li>
<li>
<p>Have two commits deployed</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@edge ~]$ rpm-ostree status
State: idle
Deployments:
● edge:rhel/9/x86_64/edge
                  Version: 9.2 (2024-10-09T22:43:27Z)
                   Commit: 4caef3752842366bbeab77b57b79854c6cb7bf4f2b62e82190cfba5d1cc3c12b

  edge:rhel/9/x86_64/edge
                  Version: 9.2 (2024-10-09T20:25:03Z)
                   Commit: 7ff678881e89e96c90eb083b905dce411740caf19c524481d7c1b848647b5746</code></pre>
</div>
</div>
</li>
<li>
<p>VM sees no updates available, try again after updating the summary, it works.</p>
<div class="paragraph">
<p>[ I cannot see how the issue linked makes --check unreliable. guess it&#8217;s just about layered packages, not about image/commit updates ]</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@edge ~]$ sudo rpm-ostree upgrade --check
2 metadata, 0 content objects fetched; 18 KiB transferred in 0 seconds; 0 bytes content written
Note: --check and --preview may be unreliable.  See https://github.com/coreos/rpm-ostree/issues/1579
AvailableUpdate:
        Version: 9.2 (2024-10-10T16:37:33Z)
         Commit: cfd48bbd633b68844c4ca8122f26e5fa36d8aad929525c61331d0aab5c3d3e88
           Diff: 2 added
[core@edge ~]$ sudo rpm-ostree upgrade
⠠ Scanning metadata: 2370                                                       37 metadata, 65 content objects fetched; 14453 KiB transferred in 3 seconds; 57.6 MB content written
Scanning metadata: 2370... done
Staging deployment... done
Added:
  php-8.0.27-1.el9_1.x86_64
  php-common-8.0.27-1.el9_1.x86_64
Run "systemctl reboot" to start a reboot</code></pre>
</div>
</div>
</li>
<li>
<p>After reboot, see that the commit from initial deployment of the VM was discarded.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@edge ~]$ rpm-ostree status
State: idle
Deployments:
● edge:rhel/9/x86_64/edge
                  Version: 9.2 (2024-10-10T16:37:33Z)
                   Commit: cfd48bbd633b68844c4ca8122f26e5fa36d8aad929525c61331d0aab5c3d3e88

  edge:rhel/9/x86_64/edge
                  Version: 9.2 (2024-10-09T22:43:27Z)
                   Commit: 4caef3752842366bbeab77b57b79854c6cb7bf4f2b62e82190cfba5d1cc3c12b
[core@edge ~]$ rpm -q cockpit
cockpit-286.1-1.el9.x86_64
[core@edge ~]$ rpm -q php
php-8.0.27-1.el9_1.x86_64--


7. Rollback to the previous image, which didn't have php, but only cockpit

.. Rollback and reboot
+
[source,subs="verbatim,quotes"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>[core@edge ~]$ sudo rpm-ostree rollback
[sudo] password for core:
Moving '4caef3752842366bbeab77b57b79854c6cb7bf4f2b62e82190cfba5d1cc3c12b.0' to be first deployment
Transaction complete; bootconfig swap: no; bootversion: boot.0.0, deployment count change: 0
Removed:
  php-8.0.27-1.el9_1.x86_64
  php-common-8.0.27-1.el9_1.x86_64
Changes queued for next boot. Run "systemctl reboot" to start a reboot
[core@edge ~]$ sudo systemctl reboot
&#8230;&#8203;</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="openblock">
<div class="content">
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>After reboot (and relogin) both commits are still in the system, but they switch order</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>[core@edge ~]$ rpm-ostree status
State: idle
Deployments:
● edge:rhel/9/x86_64/edge
                  Version: 9.2 (2024-10-09T22:43:27Z)
                   Commit: 4caef3752842366bbeab77b57b79854c6cb7bf4f2b62e82190cfba5d1cc3c12b</p>
</div>
<div class="literalblock">
<div class="content">
<pre>edge:rhel/9/x86_64/edge
                Version: 9.2 (2024-10-10T16:37:33Z)
                 Commit: cfd48bbd633b68844c4ca8122f26e5fa36d8aad929525c61331d0aab5c3d3e88</pre>
</div>
</div>
<div class="paragraph">
<p>[core@edge ~]$ rpm -q cockpit
cockpit-286.1-1.el9.x86_64
[core@edge ~]$ rpm -q php
package php is not installed</p>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>[ keeping commit hashes consistent between labs will be a pain. maye it&#8217;s time to use asciidoc attributes? ]</p>
</div>
<div class="paragraph">
<p>[ with the edge-db VM, you need to configure a remote before applying updates ]</p>
</div>
<div class="paragraph">
<p>[ there&#8217;s rpm-ostree update, to get a newer commit of the same branch, and rpm-ostree rebase, to switch to a different branch which uses a different RHEL release ]</p>
</div>
<div class="paragraph">
<p>[ to make a lab using the edge-db VM more interesting (instead of 90%+ the same as this) could configure automatic image updates
But then we&#8217;d miss automatic rollbacks (greenboot) which I didn&#8217;t put in scope here, this course is already too long
 <a href="https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/9/html-single/composing_installing_and_managing_rhel_for_edge_images/index#proc_upgrading-your-rhel-8-system-to-rhel-9_managing-rhel-for-edge-images" class="bare">https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/9/html-single/composing_installing_and_managing_rhel_for_edge_images/index#proc_upgrading-your-rhel-8-system-to-rhel-9_managing-rhel-for-edge-images</a> ]</p>
</div>
<div class="paragraph">
<p>[ After an update, grub shows two entries (new and old deployment) show it here or in the next lab with the db VM? ]</p>
</div>
<div class="paragraph">
<p>[ should I start with an empty remote ostree repo and reference it since the first build? The way it is now, the first build is different than other builds. ]</p>
</div>
<div class="paragraph">
<p>[ Use --filename to not have to deal with UUIDs? ]</p>
</div>
<div class="paragraph">
<p>[ changed the "y" version to see if image builder preserves them, and increments only the "z" number when you push a bp that overwrites an existing one ]</p>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="s3-rollback-lab.html">Lab: Rollback Edge Image Updates</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
