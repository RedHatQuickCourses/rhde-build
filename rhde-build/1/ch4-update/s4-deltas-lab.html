<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Update Edge Devices Using Static Deltas :: Building Red Hat Device Edge Images</title>
    <link rel="prev" href="s3-rollback-lab.html">
    <link rel="next" href="s5-summary.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Building Red Hat Device Edge Images</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/rhde-build/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="rhde-build" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Building Red Hat Device Edge Images</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch1-build/index.html">Build Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s1-devices.html">Introduction to Red Hat Device Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s2-devices-quiz.html">Quiz: Use Cases for Edge Devices and RHEL for Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s3-images.html">Design, Build, and Publish Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s4-install-lab.html">Lab: Install Image Builder on a Development VM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s5-blueprint.html">Create and Manage Blueprints for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s6-blueprint-lab.html">Lab: Create and Manage Blueprints for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s7-compose.html">Create Edge Images as Image Builder Composes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s8-compose-lab.html">Lab: Create and Manage Composes for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s9-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch2-publish/index.html">Publish Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-publish/s1-ostree.html">Introduction to OSTree Technology</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-publish/s2-ostree-lab.html">Lab: Create a Remote OSTree Repository</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-publish/s3-pull-local-lab.html">Lab: Publish Edge Images on Remote OSTree Repositories</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-publish/s4-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch3-test/index.html">Test Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s1-boot.html">Validate and Test Edge Images Using Virtual Machines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s2-boot-lab.html">Lab: Boot Test VMs from Remote OSTree Repositories</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s3-installer-lab.html">Lab: Boot Test VMs from Edge Installer Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s5-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Update Edge Devices with New Operating System Images</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s1-deltas.html">Apply, and Rollback Updates to Edge Devices</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s2-update-lab.html">Lab: Create And Publish Edge Image Updates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s3-rollback-lab.html">Lab: Rollback Edge Image Updates</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="s4-deltas-lab.html">Lab: Update Edge Devices Using Static Deltas</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s5-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Building Red Hat Device Edge Images</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Building Red Hat Device Edge Images</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../samples/1/index.html">samples</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../samples/1/index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Building Red Hat Device Edge Images</a></li>
    <li><a href="index.html">Update Edge Devices with New Operating System Images</a></li>
    <li><a href="s4-deltas-lab.html">Lab: Update Edge Devices Using Static Deltas</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Update Edge Devices Using Static Deltas</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Estimated reading time: <strong>14 minutes</strong>.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Objective</dt>
<dd>
<p>Update a test VM, that was provisioned using an edge installer image, using OSTree static deltas.</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Work in Progress
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_you_begin"><a class="anchor" href="#_before_you_begin"></a>Before you Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need a <em>development machine</em> with RHEL and configured with the Image Builder service, its CLI and web UI, and a user that is member of the <code>weldr</code> group. Make sure your development machine was configured and verified by following the instructions from the <a href="../ch1-build/s4-install-lab.html" class="xref page">first lab</a>.</p>
</div>
<div class="paragraph">
<p>You also need a <em>web server machine</em> which serves an OSTree repository. Make sure that machine was configured and verified by following the instructions from <a href="../ch2-publish/s2-ostree-lab.html" class="xref page">a previous lab</a>.</p>
</div>
<div class="paragraph">
<p>Finally, you need the <em>database VM</em> that you created in <a href="../ch3-test/s3-installer-lab.html" class="xref page">another lab</a>.</p>
</div>
<div class="paragraph">
<p>These instructions were tested on RHEL 9.4 [tentative!] but should work with minimal or no change on and newer and older RHEL 9.x releases.</p>
</div>
<div class="paragraph">
<p>If you are using the course classroom, you will log in on the <code>workstation</code> VM as the user <code>student</code> with password <code>student</code>, and you start SSH sessions to the <code>servera</code> VM from the same user. In this case, the <code>workstation</code> VM is your <em>development machine</em>, and the <code>servera</code> VM is your <em>web server</em> machine. If not, please adapt the instructions to your test environment.</p>
</div>
<div class="paragraph">
<p>You will perform some steps of this lab on your <em>development machine</em> and some steps on the <em>web server</em> machine. Pay attention to the instructions at each step!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instructions"><a class="anchor" href="#_instructions"></a>Instructions</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On your <em>development machine</em>, verify that you have the prerequisites from previous labs.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Check that the Image Builder service is active and that the current Linux user can submit requests to it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli status show</strong>
API server status:
    Database version:   0
    Database supported: true
    Schema version:     0
    API version:        1
    Backend:            osbuild-composer
    Build:              NEVRA:osbuild-composer-76-2.el9_2.x86_64
...</code></pre>
</div>
</div>
</li>
<li>
<p>Check that you can get the current commit ID the OSTree branch with the database edge system image that you created in <a href="../ch2-publish/s3-pull-local-lab.html" class="xref page">a previous lab</a>. Your will get a different ID.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com/repo/refs/heads/rhel/9/x86_64/db</strong>
12a22681baff58184e22ebc3e189453ed18f0984727c81311781021ccab899a1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pay attention to the final path element of the URL, which should be "db".</p>
</div>
</li>
<li>
<p>Check that you can manage local VMs, and there&#8217;s a VM left from a <a href="#ch3-test:s3-installer-lab:">previous lab</a> named <code>edge-db-1</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>virsh list --all</strong>
 Id   Name          State
---------------------------
 1    edge-test-1   shut-off
 2    edge-db-1     shut-off</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s fine the existing VM displays an status of "running" instead of "shut off".</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On your <em>development machine</em>, make changes to the edge image blueprint to add the Nano text editor.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Open the <code>rhel9-mysql.toml</code> file which you created in a <a href="../ch2-publish/s3-pull-local-lab.html" class="xref page">previous lab</a>, with any text editor.</p>
</li>
<li>
<p>Increment the version number, in tbe beginning of the TOML file, and add a <code>packages</code> section which refer to packages from Nano.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">name = "rhel9-mysql"
description = "an edge database server"
version = "0.2.0"
distro = ""

[[packages]]
name = "mysql-server"

[[packages]]
name = "nano"

[customizations]
hostname = "edge-db"

[customizations.services]
enabled = ["sshd", "mysqld"]

[customizations.firewall.services]
enabled = ["ssh", "mysql"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also download a <a href="https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/blueprints/rhel9-mysql-v2.toml">TOML file with all edits</a> from the course samples repository in GitHub. Beware that the files in the samples repository have different file names, but the same blueprint name, so they can be used as-is, without renaming.</p>
</div>
</li>
<li>
<p>Push the updated blueprint.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli push blueprints rhel9-mysql.toml</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the blueprint in the Image Builder service contains your changes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli blueprints list</strong>
mysql-installer
rhel9-edge
rhel9-mysql
$ <strong>composer-cli blueprints show rhel9-mysql</strong>
name = "rhel9-mysql"
description = "an edge database server"
version = "0.2.0"
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Still on your <em>development machine</em>, build an edge commit image from your changed blueprint.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Start a compose for an edge commit image and copy its UUID to a shell variable.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose start-ostree rhel9-db edge-commit --url http://servera.lab.example.com/repo --ref rhel/9/x86_64/db</strong>
Compose e0722e00-9cd1-4d7f-96fc-83776eac85fc added to the queue
$ <strong>UUID=e0722e00-9cd1-4d7f-96fc-83776eac85fc</strong></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Ensure that the branch name of the previous command ends with "db". You don&#8217;t want to build this image as an update to the web server image from previous labs!
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Wait until the compose finishes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose list running</strong>
ID                                     Status    Blueprint    Version   Type
e0722e00-9cd1-4d7f-96fc-83776eac85fc   RUNNING   rhel9-db     0.2.0     edge-commit
...
$ <strong>composer-cli compose list running</strong>
ID   Status   Blueprint   Version   Type
$ <strong>composer-cli compose list finished</strong>
ID                                     Status     Blueprint     Version   Type
...
e0722e00-9cd1-4d7f-96fc-83776eac85fc   FINISHED   rhel9-db      0.2.0     edge-commit
...</code></pre>
</div>
</div>
</li>
<li>
<p>Download the edge commit image and copy it to your <em>web sever machine</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose image $UUID --filename rhel9-mysql-v2-commit.tar</strong>
rhel9-mysql-v2-commit.tar
$ <strong>scp rhel9-mysql-v2-commit.tar servera:~</strong>
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On your <em>web server machine</em>, copy the new edge image to the OSTree repository.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Extract your new edge commit image and check that the OSTree repo contains the "db" branch and that your new edge commit image contains the same branch.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>mkdir delete-me</strong>
$ <strong>tar xf rhel9-mysql-v2-commit.tar -C delete-me/</strong>
$ <strong>ostree refs --repo=delete-me/repo</strong>
rhel/9/x86_64/db
$ <strong>ostree refs --repo=/var/www/html/repo</strong>
rhel/9/x86_64/edge
rhel/9/x86_64/db</code></pre>
</div>
</div>
</li>
<li>
<p>Check that your new edge commit image connects to the latest commit of the "db" branch.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree log rhel/9/x86_64/db --repo=delete-me/repo</strong>
commit 7485f70a7dbf8379b53c11548af162032260689e517eccded498d112c59460a3
Parent:  12a22681baff58184e22ebc3e189453ed18f0984727c81311781021ccab899a1
ContentChecksum:  4b48cd779032b8b360f7b7bcb79e5148fd47a110ebc0946007fd5b4045ba0da5
Date:  2024-10-21 23:02:11 +0000
Version: 9.2
(no subject)

&lt;&lt; History beyond this commit not fetched &gt;&gt;
$ <strong>ostree log rhel/9/x86_64/db --repo=/var/www/html/repo</strong>
commit 12a22681baff58184e22ebc3e189453ed18f0984727c81311781021ccab899a1
ContentChecksum:  6a4989dab6c787b5c4acc161569154cefe6928829af914bc092d65e3234489cb
Date:  2024-10-18 15:36:53 +0000
Version: 9.2
(no subject)(no subject)</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the new edge commit image to the remote OSTree repository and update its summary file. You can now delete the temporary directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo ostree pull-local --repo=/var/www/html/repo delete-me/repo</strong>
93 metadata, 105 content objects imported; 0 bytes content writte
$ <strong>sudo ostree summary -u --repo=/var/www/html/repo</strong>
$ <strong>rm -rf delete-me</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the remote OSTree repository now contains the new commit, from your new edge commit image.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree log rhel/9/x86_64/db --repo=/var/www/html/repo</strong>
commit 7485f70a7dbf8379b53c11548af162032260689e517eccded498d112c59460a3
Parent:  12a22681baff58184e22ebc3e189453ed18f0984727c81311781021ccab899a1
ContentChecksum:  4b48cd779032b8b360f7b7bcb79e5148fd47a110ebc0946007fd5b4045ba0da5
Date:  2024-10-21 23:02:11 +0000
Version: 9.2
(no subject)

commit 12a22681baff58184e22ebc3e189453ed18f0984727c81311781021ccab899a1
ContentChecksum:  6a4989dab6c787b5c4acc161569154cefe6928829af914bc092d65e3234489cb
Date:  2024-10-18 15:36:53 +0000
Version: 9.2
(no subject)</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Still on your <em>web server machine</em>, create an static delta on the remote OSTree repository.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If you&#8217;re using the HOL007 classroom, its <code>servera</code> VM has too little memory (less than 1GiB) and will fail to build static deltas. Work around that by creating and activating a swap file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>free -h</strong>
               total        used        free      shared  buff/cache   available
Mem:           771Mi       408Mi        77Mi       4.0Mi       422Mi       363Mi
Swap:             0B          0B          0B
$ <strong>sudo dd if=/dev/zero of=/swap bs=1M count=1024  ^C</strong>
$ <strong>sudo mkswap /swap</strong>
$ <strong>sudo swapon /swap</strong>
$ <strong>free -h</strong>
               total        used        free      shared  buff/cache   available
Mem:           771Mi       407Mi        77Mi       4.0Mi       422Mi       363Mi
Swap:          1.0Gi          0B       1.0Gi</code></pre>
</div>
</div>
</li>
<li>
<p>Check that there are no static deltas in the remote OSTree repository.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree static-delta list --repo /var/www/html/repo</strong>
(No static deltas)</code></pre>
</div>
</div>
</li>
<li>
<p>Create a static delta between the current database image and the previous one.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo ostree static-delta generate rhel/9/x86_64/db --repo /var/www/html/repo</strong>
Generating static delta:
  From: 12a22681baff58184e22ebc3e189453ed18f0984727c81311781021ccab899a1
  To:   7485f70a7dbf8379b53c11548af162032260689e517eccded498d112c59460a3
modified: 11
new reachable: metadata=93 content regular=103 symlink=2
rollsum for 0/11 modified
processing bsdiff: [0/11]
...
part 1 n:103 compressed:379009 uncompressed:48900526
part 2 n:94 compressed:588953 uncompressed:2660939
uncompressed=51561465 compressed=967962 loose=1340818
rollsum=0 objects, 0 bytes
bsdiff=11 objects</code></pre>
</div>
</div>
</li>
<li>
<p>Remember to update the summary file, every time you change the remote OSTree repository.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree summary -u --repo /var/www/html/repo</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Check that now the remote OSTree repository contains a static delta.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree static-delta list --repo /var/www/html/repo</strong>
12a22681baff58184e22ebc3e189453ed18f0984727c81311781021ccab899a1-7485f70a7dbf8379b53c11548af162032260689e517eccded498d112c59460a3</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Back to your <em>development machine</em>, stage the upgrade on the <em>database VM</em>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If your <em>database VM</em> is shut down, start it. Then connect to its console and log in as the user <code>core</code> with password <code>redhat123</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>virsh domstate edge-db-1</strong>
shut off
$ <strong>virsh start edge-db-1</strong>
$ <strong>virsh domstate edge-db-1</strong>
running
$ <strong>virsh console edge-db-1</strong>
...
edge-db login:</code></pre>
</div>
</div>
</li>
<li>
<p>Check that your <em>database VM</em> is running the system image from the OSTree commit ID you got at the beginning of this lab.</p>
<div class="paragraph">
<p>There should be a single deployment, that is, a single OSTree commit and system image on the local OSTree repository, because the <em>database VM</em> wasn&#8217;t updated yet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@edge-db ~]$ <strong>rpm-ostree status</strong>
State: idle
Deployments:
● edge:rhel/9/x86_64/edge
                  Version: 9.2 (2024-10-09T20:25:03Z)
                   Commit: 12a22681baff58184e22ebc3e189453ed18f0984727c81311781021ccab899a1</code></pre>
</div>
</div>
</li>
<li>
<p>Check that your <em>database VM</em> contains MySQL packages but no Nano packages.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@edge-db ~]$ <strong>rpm -q mysql</strong>
mysql-8.0.30-3.el9_0.x86_64
[core@edge-db ~]$ <strong>rpm -q nano</strong>
package nano is not installed</code></pre>
</div>
</div>
</li>
<li>
<p>Check that, because this VM was provisioned using an edge installer image, it is NOT configured with a valid OSTree remote.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@edge-db ~]$ <strong>ostree remote list --show-urls</strong>
db  file:///run/install/repo/ostree/repo</code></pre>
</div>
</div>
</li>
<li>
<p>Configure you <em>database VM</em> with an OSTree remote that points to your <em>web server</em> machine.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@edge-db ~]$ <strong>sudo ostree remote delete db</strong>
[core@edge-db ~]$ <strong>sudo ostree remote add --no-gpg-verify db http://servera.lab.example.com/repo</strong>
[core@edge-db ~]$ <strong>ostree remote list --show-urls</strong>
db  http://servera.lab.example.com/repo</code></pre>
</div>
</div>
</li>
<li>
<p>Check that your <em>database VM</em> can find available updates on the remote OSTree repository.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@edge-db ~]$ <strong>sudo rpm-ostree upgrade --check</strong>
2 metadata, 0 content objects fetched; 18 KiB transferred in 0 seconds; 0 bytes content written
Note: --check and --preview may be unreliable.  See https://github.com/coreos/rpm-ostree/issues/1579
AvailableUpdate:
        Version: 9.2 (2024-10-21T23:02:11Z)
         Commit: 7485f70a7dbf8379b53c11548af162032260689e517eccded498d112c59460a3
           Diff: 1 added</code></pre>
</div>
</div>
</li>
<li>
<p>Stage the upgrade and reboot the <em>database VM</em> to apply its updates. Then check it&#8217;s running the new system image, which contains the Nano text editor.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@edge-db ~]$ <strong>sudo rpm-ostree upgrade</strong>
...
Staging deployment... done
Added:
  nano-5.6.1-5.el9.x86_64
Run "systemctl reboot" to start a reboot
$ <strong>sudo systemctl reboot</strong>
...
edge-db login:
...
[core@edge-db ~]$ <strong>rpm-ostree status</strong>
State: idle
Deployments:
● db:rhel/9/x86_64/db
                  Version: 9.2 (2024-10-21T23:02:11Z)
                   Commit: 7485f70a7dbf8379b53c11548af162032260689e517eccded498d112c59460a3

  db:rhel/9/x86_64/db
                  Version: 9.2 (2024-10-18T15:36:53Z)
                   Commit: 12a22681baff58184e22ebc3e189453ed18f0984727c81311781021ccab899a1
[core@edge-db ~]$ <strong>rpm -q nano</strong>
nano-5.6.1-5.el9.x86_64</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Still on your <em>development machine</em>, verify that your <em>database VM</em> actually fetched upgrades using static deltas.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Search the system logs on the <em>database VM</em>. You should see two entries with a message <code>libostree pull</code>: one from checking for updates, which refers to no deltas and has a small transfer size, and another from the actual upgrade operation, which refers to a delta and with a larger transfer size.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@edge-db ~]$ <strong>sudo journalctl --no-pager -t rpm-ostree -g pull</strong>
Oct 22 15:39:53 db rpm-ostree[1246]: libostree pull from 'db' for rhel/9/x86_64/db complete
                                     security: GPG: disabled
                                     security: SIGN: disabled http: TLS
                                     non-delta: meta: 2 content: 0
                                     transfer: secs: 0 size: 18.5 kB
Oct 22 15:40:45 db rpm-ostree[1246]: libostree pull from 'db' for rhel/9/x86_64/db complete
                                     security: GPG: disabled
                                     security: SIGN: disabled http: TLS
                                     delta: parts: 2 loose: 2
                                     transfer: secs: 3 size: 993.2 kB
-- Boot c7ab9e1e55944e17a38672c152c9106d --</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you do not see any evidence of using static deltas to perform the upgrade operation, it might be because you forgot to update the summary file of the remote OSTree repository after creating the static delta. In that case, the upgrade didn&#8217;t use the available static delta.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If you search the system log of the <em>test VM</em> from the previous labs, your would see entries similar to the following.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Oct 22 16:39:47 edge rpm-ostree[1232]: libostree pull from 'edge' for rhel/9/x86_64/edge complete
                                       security: GPG: disabled
                                       security: SIGN: disabled http: TLS
                                       non-delta: meta: 2 content: 0
                                       transfer: secs: 0 size: 18.5 kB
Oct 22 16:40:00 edge rpm-ostree[1232]: libostree pull from 'edge' for rhel/9/x86_64/edge complete
                                       security: GPG: disabled
                                       security: SIGN: disabled http: TLS
                                       non-delta: meta: 507 content: 1893
                                       transfer: secs: 7 size: 121.5 MB
-- Boot dc233afb346f4aa2b9e25d64ae9f4c3c --</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that all entries are <code>non-delta</code> pulls.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Switch to your <em>web server machine</em> and verify that the web server served requests for using static deltas.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Check the last lines of the access logs of the Apache Web Server. They should include requests with a path of <code>/repo/deltas</code> which refer to the two parts of the delta as seen on the logs from the <code>rpm-ostree</code> command in the previous step.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo tail /var/log/httpd/access_log</strong>
172.25.250.9 - - [22/Oct/2024:15:43:42 -0400] "GET /repo/objects/74/85f70a7dbf8379b53c11548af162032260689e517eccded498d112c59460a3.commitmeta HTTP/1.1" 404 196 "-" "libostree/2022.6"
172.25.250.9 - - [22/Oct/2024:15:43:42 -0400] "GET /repo/objects/74/85f70a7dbf8379b53c11548af162032260689e517eccded498d112c59460a3.commit HTTP/1.1" 200 18260 "-" "libostree/2022.6"
172.25.250.9 - - [22/Oct/2024:15:44:29 -0400] "GET /repo/summary.sig HTTP/1.1" 404 196 "-" "libostree/2022.6"
172.25.250.9 - - [22/Oct/2024:15:44:29 -0400] "GET /repo/summary HTTP/1.1" 200 672 "-" "libostree/2022.6" <i class="conum" data-value="1"></i><b>(1)</b>
172.25.250.9 - - [22/Oct/2024:15:44:29 -0400] "GET /repo/config HTTP/1.1" 200 58 "-" "libostree/2022.6"
172.25.250.9 - - [22/Oct/2024:15:44:29 -0400] "GET /repo/delta-indexes/dI/X3Cn2_g3m1PBFUivFiAyJgaJ5Rfsze1JjREsWUYKM.index HTTP/1.1" 200 205 "-" "libostree/2022.6" <i class="conum" data-value="2"></i><b>(2)</b>
172.25.250.9 - - [22/Oct/2024:15:44:29 -0400] "GET /repo/deltas/NJ/F_p7mLUGVaFohIhIZAg08t_5AOM_B9alxYSLKRm44-dIX3Cn2_g3m1PBFUivFiAyJgaJ5Rfsze1JjREsWUYKM/superblock HTTP/1.1" 200 25012 "-" "libostree/2022.6" <i class="conum" data-value="3"></i><b>(3)</b>
172.25.250.9 - - [22/Oct/2024:15:44:29 -0400] "GET /repo/deltas/NJ/ F_p7mLUGVaFohIhIZAg08t_5AOM_B9alxYSLKRm44-dIX3Cn2_g3m1PBFUivFiAyJgaJ5Rfsze1JjREsWUYKM/0 HTTP/1.1" 200 379009 "-" "libostree/2022.6" <i class="conum" data-value="4"></i><b>(4)</b>
172.25.250.9 - - [22/Oct/2024:15:44:29 -0400] "GET /repo/deltas/NJ/F_p7mLUGVaFohIhIZAg08t_5AOM_B9alxYSLKRm44-dIX3Cn2_g3m1PBFUivFiAyJgaJ5Rfsze1JjREsWUYKM/1 HTTP/1.1" 200 588953 "-" "libostree/2022.6" <i class="conum" data-value="5"></i><b>(5)</b>
172.25.250.9 - - [22/Oct/2024:16:02:35 -0400] "HEAD /repo HTTP/1.1" 301 - "-" "curl/7.76.1"</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Request for the summary file, from which an edge device finds about the availability of static deltas.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Request for the indexes of deltas, from which an edge device finds if there&#8217;s a delta that matches its upgrade operations</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Request for the superblock of the desired delta, from which an edge device finds its parts</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Request for part 1 of the delta</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Request for part 2 of the delta</td>
</tr>
</table>
</div>
</li>
<li>
<p>If you were checking the logs from upgrading the <em>test VM</em> from the previous lab, you would see requests similar to the following.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
172.25.250.9 - - [22/Oct/2024:16:39:52 -0400] "GET /repo/summary HTTP/1.1" 200 672 "-" "libostree/2022.6" <i class="conum" data-value="1"></i><b>(1)</b>
172.25.250.9 - - [22/Oct/2024:16:39:52 -0400] "GET /repo/config HTTP/1.1" 200 58 "-" "libostree/2022.6"
172.25.250.9 - - [22/Oct/2024:16:39:52 -0400] "GET /repo/delta-indexes/k1/Buyn565biiarvRuIyecbXDRoMYVrzR5IcYoZFo68w.index HTTP/1.1" 404 196 "-" "libostree/2022.6" <i class="conum" data-value="2"></i><b>(2)</b>
172.25.250.9 - - [22/Oct/2024:16:39:52 -0400] "GET /repo/objects/93/506eca7e7ae5b8a26abbd1b88c9e71b5c346831856bcd1e48718a19168ebcc.commitmeta HTTP/1.1" 404 196 "-" "libostree/2022.6" <i class="conum" data-value="3"></i><b>(3)</b>
172.25.250.9 - - [22/Oct/2024:16:39:52 -0400] "GET /repo/objects/eb/049ca6ed02d59965726ea3820798c6295f72643447e40e1e70405bcee57fad.dirtree HTTP/1.1" 200 1095 "-" "libostree/2022.6" <i class="conum" data-value="4"></i><b>(4)</b>
172.25.250.9 - - [22/Oct/2024:16:39:52 -0400] "GET /repo/objects/0c/838feff043ef5f56180b54e340733174765fb47c51341edc6937cb5b724970.dirtree HTTP/1.1" 200 815 "-" "libostree/2022.6"
172.25.250.9 - - [22/Oct/2024:16:39:52 -0400] "GET /repo/objects/56/76902fc461f868f4e2f1b214a21b582b9c941a6dfd9fcbc114d234d65c14dd.dirtree HTTP/1.1" 200 34351 "-" "libostree/2022.6"
172.25.250.9 - - [22/Oct/2024:16:39:52 -0400] "GET /repo/objects/7e/a2c5410038e1f58baeddddee3b775e64c304296f574c872f5f92e8623df2d0.dirtree HTTP/1.1" 200 9675 "-" "libostree/2022.6"
172.25.250.9 - - [22/Oct/2024:16:39:52 -0400] "GET /repo/objects/a6/5d2dc8c573696c941646077906a4984ef9ab485d565170e45940508dc96812.dirtree HTTP/1.1" 200 2699 "-" "libostree/2022.6"
172.25.250.9 - - [22/Oct/2024:16:39:52 -0400] "GET /repo/objects/a6/35c3efc51056fe97f5674427f12574b9e9ed925959afc64b1634713df02abb.dirtree HTTP/1.1" 200 32916 "-" "libostree/2022.6"
172.25.250.9 - - [22/Oct/2024:16:39:52 -0400] "GET /repo/objects/6a/66c95127808bb8c723e163b7a0557a54f010132deb04b70a15bd15d0269f74.dirtree HTTP/1.1" 200 4454 "-" "libostree/2022.6"
172.25.250.9 - - [22/Oct/2024:16:39:52 -0400] "GET /repo/objects/13/5479584d3d98616cedfb7c334995cb819177b7c13966e7386bb39b72b2e863.dirtree HTTP/1.1" 200 19012 "-" "libostree/2022.6"
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Request for the summary file, from which an edge device finds about the availability of static deltas.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Request for the indexes of deltas, notice it fails with HTTP error 404 because there are no deltas for the commit on the <em>test VM</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Request for the commit metadata, from which an edge device gets a list of files on the OSTree commit.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>From now on, many requests, possibly hundreds or thousands, one for each individual file and directory in the OSTree commit.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>As you see, the usage of static deltas is transparent to administrators of edge devices. Upgrades will not fail because there are no static deltas, and you wouldn&#8217;t notice any performance improvement if your updates are small as in the examples of this course and network connectivity between edge devices end their remote OSTree repositories is good.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps"><a class="anchor" href="#_next_steps"></a>Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This was the last activity in this course. Stay tuned for the remaining Red Hat Device Edge courses, which feature MicroShift, Ansible Automation, Green Boot and FDO.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="s3-rollback-lab.html">Lab: Rollback Edge Image Updates</a></span>
  <span class="next"><a href="s5-summary.html">Summary</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
