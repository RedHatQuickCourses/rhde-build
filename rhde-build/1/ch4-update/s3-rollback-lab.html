<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Rollback Edge Image Updates :: Building Red Hat Device Edge Images</title>
    <link rel="prev" href="s2-update-lab.html">
    <link rel="next" href="s4-deltas-lab.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Building Red Hat Device Edge Images</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/rhde-build/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="rhde-build" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Building Red Hat Device Edge Images</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch1-build/index.html">Build Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s1-devices.html">Introduction to Red Hat Device Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s2-devices-quiz.html">Quiz: Use Cases for Edge Devices and RHEL for Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s3-images.html">Design, Build, and Publish Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s4-install-lab.html">Lab: Install Image Builder on a Development VM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s5-blueprint.html">Create and Manage Blueprints for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s6-blueprint-lab.html">Lab: Create and Manage Blueprints for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s7-compose.html">Create Edge Images as Image Builder Composes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s8-compose-lab.html">Lab: Create and Manage Composes for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s9-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch2-publish/index.html">Publish Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-publish/s1-ostree.html">Introduction to OSTree Technology</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-publish/s2-ostree-lab.html">Lab: Create a Remote OSTree Repository</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-publish/s3-pull-local-lab.html">Lab: Publish Edge Images on Remote OSTree Repositories</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-publish/s4-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch3-test/index.html">Test Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s1-boot.html">Validate and Test Edge Images Using Virtual Machines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s2-boot-lab.html">Lab: Boot Test VMs from Remote OSTree Repostories</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s3-installer-lab.html">Lab: Boot Test VMs from Edge Installer Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s5-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Update Edge Devices with New Operating System Images</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s1-deltas.html">Apply, and Rollback Updates to Edge Devices</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s2-update-lab.html">Lab: Create And Publish Edge Image Updates</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="s3-rollback-lab.html">Lab: Rollback Edge Image Updates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s4-deltas-lab.html">Lab: Update Edge Devices Using Static Deltas</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Building Red Hat Device Edge Images</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Building Red Hat Device Edge Images</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../samples/1/index.html">samples</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../samples/1/index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Building Red Hat Device Edge Images</a></li>
    <li><a href="index.html">Update Edge Devices with New Operating System Images</a></li>
    <li><a href="s3-rollback-lab.html">Lab: Rollback Edge Image Updates</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Rollback Edge Image Updates</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Estimated reading time: <strong>12 minutes</strong>.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Objective</dt>
<dd>
<p>Rollback a test VM to a previous known good RHEL for Edge system image.</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Work in Progress
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_you_begin"><a class="anchor" href="#_before_you_begin"></a>Before you Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need a <em>development machine</em> with RHEL and configured with the Image Builder service, its CLI and web UI, and a user that is member of the <code>weldr</code> group. Make sure your development machine was configured and verified by following the instructions from the <a href="../ch1-build/s4-install-lab.html" class="xref page">first lab</a>.</p>
</div>
<div class="paragraph">
<p>You also need a <em>web server machine</em> which serves an OSTree repository. Make sure that machine was configured and verified by following the instructions from <a href="../ch2-publish/s2-ostree-lab.html" class="xref page">a previous lab</a>.</p>
</div>
<div class="paragraph">
<p>Finally, you need the <em>test VM</em> that you updated in <a href="s2-update-lab.html" class="xref page">the previous lab</a>. While you could perform the focus tasks in this lab on a <em>test VM</em> that was never updated before, that is, you can rollback the first update of an edge device, the instructions and outputs here assume that there are previous updates already applied to the <em>test VM</em>, to demonstrate that RPM-OSTree automatically prunes older system updates.</p>
</div>
<div class="paragraph">
<p>These instructions were tested on RHEL 9.4 [tentative!] but should work with minimal or no change on and newer and older RHEL 9.x releases.</p>
</div>
<div class="paragraph">
<p>If you are using the course classroom, you will log in on the <code>workstation</code> VM as the user <code>student</code> with password <code>student</code>, and you start SSH sessions to the <code>servera</code> VM from the same user. In this case, the <code>workstation</code> VM is your <em>development machine</em>, and the <code>servera</code> VM is your <em>web server</em> machine. If not, please adapt the instructions to your test environment.</p>
</div>
<div class="paragraph">
<p>You will perform some steps of this lab on your <em>development machine</em> and some steps on the <em>web server</em> machine. Pay attention to the instructions at each step!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instructions"><a class="anchor" href="#_instructions"></a>Instructions</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On your <em>development machine</em>, verify that you have the prerequisites from previous labs.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Check that the Image Builder service is active and that the current Linux user can submit requests to it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli status show</strong>
API server status:
    Database version:   0
    Database supported: true
    Schema version:     0
    API version:        1
    Backend:            osbuild-composer
    Build:              NEVRA:osbuild-composer-76-2.el9_2.x86_64
...</code></pre>
</div>
</div>
</li>
<li>
<p>Check that you can get the current commit ID the OSTree branch with the Apache Web Server system image update that you created in <a href="s2-update-lab.html" class="xref page">the previous lab</a>. You will get a different ID:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com/repo/refs/heads/rhel/9/x86_64/edge</strong>
4afeda6a96ec8b2c263b6965a9c3f92db1db2436ae1e1233da70b7776fc6137b</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pay attention to the final path element of the URL, which should be "edge". The commit ID you get should be the active commit in your <em>test VM</em> and it will be the parent commit of the new update image you are building during this lab.</p>
</div>
</li>
<li>
<p>Check that you can manage local VMs, and there&#8217;s a VM left from the <a href="#s2-update-lab:">previous lab</a> named <code>edge-test-1</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>virsh list --all</strong>
 Id   Name          State
---------------------------
 1    edge-test-1   shut-off
 2    edge-db-1     shut-off</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s fine if the existing VM displays an status of "running" instead of "shut off".</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Make changes to the edge image blueprint to add the PHP packages.</p>
<div class="paragraph">
<p>This similar to what you did in the previous lab. It&#8217;s just another update image, which should pick whatever is the current HEAD of the remote OSTree repository as its parent.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Open the <code>rhel9-httpd.toml</code> file which you edited in the <a href="s2-update-lab.html" class="xref page">previous lab</a>, with any text editor.</p>
</li>
<li>
<p>Increment the version number, in tbe beginning of the TOML file, and add two <code>packages</code> sections, one for the PHP interpreter and another for the PHP-FastCGI engine. There is no need to change any of the <code>customizations</code> section. After your edits, the TOML file should look like the following:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">name = "rhel9-edge"
description = "blueprint-rhel9-edge"
version = "0.3.0"
modules = []
groups = []
distro = ""

[[packages]]
name = "cockpit"

[[packages]]
name = "httpd"

[[packages]]
name = "php"

[[packages]]
name = "php-fpm"

...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also download a <a href="https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/blueprints/rhel9-httpd-v3.toml">TOML file with all edits</a> from the course samples repository in GitHub. Beware that the file in the samples repository have different file names, but the same blueprint name, so they can be used as-is, without renaming.</p>
</div>
</li>
<li>
<p>Push the updated blueprint.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli push blueprints rhel9-httpd.toml</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the blueprint in the Image Builder service contains your changes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli blueprints list</strong>
mysql-installer
rhel9-edge
rhel9-mysql
$ <strong>composer-cli blueprints show rhel9-edge</strong>
name = "rhel9-edge"
description = "blueprint-rhel9-edge"
version = "0.3.0"
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Still on your <em>development machine</em>, build another new edge commit image from your changed blueprint.</p>
<div class="paragraph">
<p>This is similar to what you did in the previous lab. You just need something different from the previous images so you later can verify that your <em>test VM</em> got the right updates.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Start a compose for an edge commit image and copy its UUID to a shell variable.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose start-ostree rhel9-edge edge-commit --url http://servera.lab.example.com/repo --ref rhel/9/x86_64/edge</strong>
Compose fb5ef664-1def-4589-919d-1a0681f86371 added to the queue
$ <strong>UUID=fb5ef664-1def-4589-919d-1a0681f86371</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Wait until the compose finishes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose list running</strong>
ID                                     Status    Blueprint    Version   Type
fb5ef664-1def-4589-919d-1a0681f86371   RUNNING   rhel9-edge   0.3.0     edge-commit
...
$ <strong>composer-cli compose list running</strong>
ID   Status   Blueprint   Version   Type</code></pre>
</div>
</div>
</li>
<li>
<p>Make sure your compose finished sucessfully. Pay attention to the compose UUID and version so you don&#8217;t check the status of the wrong compose.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose list finished</strong>
ID                                     Status     Blueprint     Version   Type
...
fb5ef664-1def-4589-919d-1a0681f86371   FINISHED   rhel9-edge    0.3.0     edge-commit
...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can alternatively use a <a href="https://raw.githubusercontent.com/RedHatQuickCourses/rhde-build-samples/refs/heads/main/sh/status-compose.sh">simple Bash script</a> that returns the status of a compose given its UUID.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Download the edge commit image and copy it to your <em>web sever machine</em>.</p>
<div class="paragraph">
<p>Be careful to not overwrite the TAR files of previous edge commit images, because you might need them to reconstruct your remote OSTree repository in case you make mistakes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose image $UUID --filename rhel9-httpd-v3-commit.tar</strong>
rhel9-httpd-v3-commit.tar
$ <strong>scp rhel9-httpd-v3-commit.tar servera:~</strong>
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On your <em>web server machine</em>, copy the new edge image to the OSTree repository.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Extract your new edge commit image into an empty temporary directory and check that its parent commit exists on the OSTree repository of the <em>web server</em> machine.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ls rhel9-httpd-v3-commit.tar</strong>
rhel9-httpd-v3-commit.tar
$ <strong>mkdir delete-me</strong>
$ <strong>tar xf rhel9-httpd-v3-commit.tar -C delete-me/</strong>
$ <strong>ostree log rhel/9/x86_64/edge --repo=delete-me/repo</strong>
commit cfd48bbd633b68844c4ca8122f26e5fa36d8aad929525c61331d0aab5c3d3e88 <i class="conum" data-value="1"></i><b>(1)</b>
Parent:  4afeda6a96ec8b2c263b6965a9c3f92db1db2436ae1e1233da70b7776fc6137b <i class="conum" data-value="2"></i><b>(2)</b>
ContentChecksum:  94e275f4f9c9a9f68426ed9421845a48065467aea8bfcb57d826ed43fa50a253
2024-10-17 15:11:55 +000
Version: 9.2
(no subject)

&lt;&lt; History beyond this commit not fetched &gt;&gt;
$ <strong>ostree log rhel/9/x86_64/edge --repo=/var/www/html/repo</strong>
commit 4afeda6a96ec8b2c263b6965a9c3f92db1db2436ae1e1233da70b7776fc6137b <i class="conum" data-value="3"></i><b>(3)</b>
Parent:  7ff678881e89e96c90eb083b905dce411740caf19c524481d7c1b848647b5746
ContentChecksum:  94e275f4f9c9a9f68426ed9421845a48065467aea8bfcb57d826ed43fa50a253
Date:  2024-10-09 22:43:27 +0000
Version: 9.2
(no subject)

commit 7ff678881e89e96c90eb083b905dce411740caf19c524481d7c1b848647b5746
ContentChecksum:  f938c449602ad38c31a74bd35f0e438beb833e8ca592c07c87ef90a56f659586
Date:  2024-10-09 20:25:03 +0000
Version: 9.2
(no subject)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Commit ID of the new edge commit image</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Parent commit of the new edge image</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Current Head of the OSTree repository, should match the parent commit.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Pull your new edge commit image from the temporary directory into your OSTree repository and update its summary file. You can now delete the temporary directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo ostree pull-local --repo=/var/www/html/repo delete-me/repo</strong>
36 metadata, 65 content objects imported; 0 bytes content written
$ <strong>sudo ostree summary -u --repo=/var/www/html/repo</strong>
$ <strong>rm -rf delete-me</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the OSTree repo now contains the commit ID from your new edge container image as its HEAD and still contains all previous commit IDs.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree log rhel/9/x86_64/edge --repo=/var/www/html/repo</strong>
commit cfd48bbd633b68844c4ca8122f26e5fa36d8aad929525c61331d0aab5c3d3e88 <i class="conum" data-value="1"></i><b>(1)</b>
Parent:  4afeda6a96ec8b2c263b6965a9c3f92db1db2436ae1e1233da70b7776fc6137b <i class="conum" data-value="2"></i><b>(2)</b>
ContentChecksum:  645322fc333084d0613ebfc43f8dbe8c1fe1ae19c9e176270dd2bc7688c6145a
Date:  2024-10-17 15:11:55 +0000
Version: 9.2
(no subject)

commit 4afeda6a96ec8b2c263b6965a9c3f92db1db2436ae1e1233da70b7776fc6137b <i class="conum" data-value="3"></i><b>(3)</b>
Parent:  7ff678881e89e96c90eb083b905dce411740caf19c524481d7c1b848647b5746 <i class="conum" data-value="4"></i><b>(4)</b>
ContentChecksum:  94e275f4f9c9a9f68426ed9421845a48065467aea8bfcb57d826ed43fa50a253
Date:  2024-10-09 22:43:27 +0000
Version: 9.2
(no subject)

commit 7ff678881e89e96c90eb083b905dce411740caf19c524481d7c1b848647b5746 <i class="conum" data-value="5"></i><b>(5)</b>
ContentChecksum:  f938c449602ad38c31a74bd35f0e438beb833e8ca592c07c87ef90a56f659586
Date:  2024-10-09 20:25:03 +0000
Version: 9.2
(no subject)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Commit ID of the new edge commit image</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Parent commit of the new edge commit image</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Previous commit, it was the HEAD at the beginning of this lab</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Parent commmit of the previous commit, it was the initial commit</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Initial commit</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Still on your <em>development machine</em>, stage the new edge commit image on your <em>test VM</em>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If your <em>test VM</em> is shut down, start it. Then and connect to its console and log in as the user <code>core</code> with password <code>redhat123</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>virsh domstate edge-test-1</strong>
shut off
$ <strong>virsh start edge-test-1</strong>
$ <strong>virsh domstate edge-test-1</strong>
running
$ <strong>virsh console edge-test-1</strong>
...
microweb login:</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that your <em>test VM</em> is running the system image from the OSTree commit ID you got at the beginning of this lab. Notice that there are two OSTree deployments, because your <em>test VM</em> was already updated in the previous lab.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@microweb ~]$ <strong>rpm-ostree status</strong>
State: idle
Deployments:
● edge:rhel/9/x86_64/edge
                  Version: 9.2 (2024-10-09T20:25:03Z)
                   Commit: 4afeda6a96ec8b2c263b6965a9c3f92db1db2436ae1e1233da70b7776fc6137b
  edge:rhel/9/x86_64/edge
                  Version: 9.2 (2024-10-09T20:25:03Z)
                   Commit: 7ff678881e89e96c90eb083b905dce411740caf19c524481d7c1b848647b5746</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that your <em>test VM</em> does not contain any PHP packages.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@microweb ~]$ <strong>rpm -q php</strong>
package php is not installed</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that your <em>test VM</em> finds another update available in the remote OSTree repository. The commit ID of the update should match the commit ID of your new edge commit image.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@microweb ~]$ <strong>sudo rpm-ostree upgrade --check</strong>
2 metadata, 0 content objects fetched; 18 KiB transferred in 0 seconds; 0 bytes content written
Note: --check and --preview may be unreliable.  See https://github.com/coreos/rpm-ostree/issues/1579
AvailableUpdate:
        Version: 9.2 (2024-10-17T15:11:55Z)
         Commit: cfd48bbd633b68844c4ca8122f26e5fa36d8aad929525c61331d0aab5c3d3e88
           Diff: 2 added</code></pre>
</div>
</div>
</li>
<li>
<p>Stage the upgrade on your <em>test VM</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@microweb ~]$ <strong>sudo rpm-ostree upgrade</strong>
⠤ Scanning metadata: 2691                                                       37 metadata, 65 content objects fetched; 14453 KiB transferred in 4 seconds; 57.6 MB content written
Scanning metadata: 2691... done
Staging deployment... done
Added:
  nginx-filesystem-1:1.20.1-14.el9.noarch
  php-8.0.27-1.el9_1.x86_64
  php-common-8.0.27-1.el9_1.x86_64
  php-fpm-8.0.27-1.el9_1.x86_64
Run "systemctl reboot" to start a reboot</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Still on your <em>development machine</em>, apply the upgrade to your <em>test VM</em> and verify it is running the new edge commit image you built during this lab.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Reboot your <em>test VM</em> and verify that the older commit was discarded by RPM-OSTree, so the local repository of the edge device stays with only two commits.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@microweb ~]$ <strong>sudo systemctl reboot</strong>
...
microweb login:
...
[core@microweb ~]$ <strong>rpm-ostree status</strong>
State: idle
Deployments:
● edge:rhel/9/x86_64/edge
                  Version: 9.2 (2024-10-17T15:11:55Z)
                   Commit: cfd48bbd633b68844c4ca8122f26e5fa36d8aad929525c61331d0aab5c3d3e88

  edge:rhel/9/x86_64/edge
                  Version: 9.2 (2024-10-15T20:27:34Z)
                   Commit: 7ff678881e89e96c90eb083b905dce411740caf19c524481d7c1b848647b5746</code></pre>
</div>
</div>
</li>
<li>
<p>To prove it&#8217;s running the new edge commit image, verify it contains the PHP packages:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@microweb ~]$ <strong>rpm -q php</strong>
php-8.0.27-1.el9_1.x86_64</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Still on your <em>development machine</em>, change configurations and application data on your <em>test VM</em>, so you can verify if those changes are retained by rolling back an update.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Change the timezone of your <em>test VM</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@microweb ~]$ <strong>date</strong>
Thu Oct 17 21:45:58 UTC 2024
[core@microweb ~]$ <strong>sudo timedatectl set-timezone America/Aruba</strong>
[core@microweb ~]$ <strong>date</strong>
Thu Oct 17 17:46:53 AST 2024</code></pre>
</div>
</div>
</li>
<li>
<p>Using a text editor, create the <code>/var/www/html/info.php</code> script with the following contents;</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">&lt;html&gt;
&lt;body&gt;
This is PHP version: &lt;?= phpversion() ?&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Check that the Apache Web Server inside your <em>test VM</em> runs your PHP script.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@microweb ~]$ <strong>curl http://127.0.0.1/info.php</strong>
&lt;html&gt;
&lt;body&gt;
This is PHP version: 8.0.27&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Still on your <em>developer machine</em>, suppose that you discovered the new edge commit image contains a serious security issue and you must rollback your <em>test VM</em> to the previous system image, to verify that the bad update can be rolled back.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Rollback your <em>test VM</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@microweb ~]$ <strong>sudo rpm-ostree rollback</strong>
Moving '4afeda6a96ec8b2c263b6965a9c3f92db1db2436ae1e1233da70b7776fc6137b.0' to be first deployment
Transaction complete; bootconfig swap: no; bootversion: boot.0.0, deployment count change: 0
Removed:
  nginx-filesystem-1:1.20.1-14.el9.noarch
  php-8.0.27-1.el9_1.x86_64
  php-common-8.0.27-1.el9_1.x86_64
  php-fpm-8.0.27-1.el9_1.x86_64
Changes queued for next boot. Run "systemctl reboot" to start a reboot</code></pre>
</div>
</div>
</li>
<li>
<p>Check that now the old commit is marked as the one for the next boot (notice the bullet on the second deployment) but the current commit was NOT discarded by rolling back from it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@microweb ~]$ <strong>rpm-ostree status</strong>
State: idle
Deployments:
  edge:rhel/9/x86_64/edge
                  Version: 9.2 (2024-10-15T20:27:34Z)
                   Commit: cfd48bbd633b68844c4ca8122f26e5fa36d8aad929525c61331d0aab5c3d3e88
                     Diff: 2 removed

  ● edge:rhel/9/x86_64/edge
                  Version: 9.2 (2024-10-17T15:11:55Z)
                   Commit: 4afeda6a96ec8b2c263b6965a9c3f92db1db2436ae1e1233da70b7776fc6137b</code></pre>
</div>
</div>
</li>
<li>
<p>After reboot (and login) both commits are still in the system, but they switch order. Notice that the second deployment is the newer commit, which was the bad update, and is now inactive.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@microweb ~]$ <strong>sudo systemctl reboot</strong>
...
microweb login:
...
[core@microweb ~]$ <strong>rpm-ostree status</strong>
State: idle
Deployments:
● edge:rhel/9/x86_64/edge
                  Version: 9.2 (2024-10-15T20:27:34Z)
                   Commit: 4afeda6a96ec8b2c263b6965a9c3f92db1db2436ae1e1233da70b7776fc6137b

  edge:rhel/9/x86_64/edge
                  Version: 9.2 (2024-10-17T15:11:55Z)
                   Commit: cfd48bbd633b68844c4ca8122f26e5fa36d8aad929525c61331d0aab5c3d3e88</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the <em>test VM</em> does NOT contain PHP packages anymore, but still contains the Cockpit packages, so it is indeed running the update from the previous lab.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@microweb ~]$ <strong>rpm -q php</strong>
package php is not installed
[core@microweb ~]$ <strong>rpm -q cockpit</strong>
cockpit-286.1-1.el9.x86_64</code></pre>
</div>
</div>
</li>
<li>
<p>Check that your <em>test VM</em> still contains the changes to timezone and the PHP script, which doesn&#8217;t work anymore because there&#8217;s no PHP engine on its Apache Web Server.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[core@microweb ~]$ <strong>date</strong>
Thu Oct 17 22:45:04 UTC 2024
[core@microweb ~]$ <strong>timedatectl show -p Timezone</strong>
Timezone=Etc/UTC
[core@microweb ~]$ <strong>curl http://127.0.0.1/info.php</strong>
&lt;html&gt;
&lt;body&gt;
This is PHP version: &lt;?= phpversion() ?&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>As you see, rolling back an RPM-OSTree system just switches the active system image for the next boot. The newer but inactive system image remains available in edge devices, and could me marked active again, until a future upgrade removes it.</p>
</div>
<div class="paragraph">
<p>Also notice that a system rollback does NOT rollbacks changes to configuration and application data. If your upgrade required special handling of application data, your rollback will also require it.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps"><a class="anchor" href="#_next_steps"></a>Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The next and final lab of this course applies updates to a VM that was provisioned using an edge installer image and demonstrates the use of static deltas for faster staging of updates.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="s2-update-lab.html">Lab: Create And Publish Edge Image Updates</a></span>
  <span class="next"><a href="s4-deltas-lab.html">Lab: Update Edge Devices Using Static Deltas</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
