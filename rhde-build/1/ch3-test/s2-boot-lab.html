<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Boot Edge VMs from Remote OSTree Repostories :: Building Red Hat Device Edge Images</title>
    <link rel="prev" href="s1-boot.html">
    <link rel="next" href="s3-installer-lab.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Building Red Hat Device Edge Images</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/rhde-build/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="rhde-build" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Building Red Hat Device Edge Images</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch1-build/index.html">Build Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s1-devices.html">Introduction to Red Hat Device Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s2-devices-quiz.html">Quiz: Use Cases for Edge Devices and RHEL for Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s3-images.html">Design, Build, and Publish Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s4-install-lab.html">Lab: Install Image Builder on a Development VM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s5-blueprint.html">Create and Manage Blueprints for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s6-blueprint-lab.html">Lab: Create and Manage Blueprints for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s7-compose.html">Create Edge Images as Image Builder Composes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s8-compose-lab.html">Lab: Create and Manage Composes for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s9-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch2-publish/index.html">Publish Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-publish/s1-ostree.html">Introduction to OSTree Technology</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-publish/s2-ostree-lab.html">Lab: Create a Remote OSTree Repository</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-publish/s3-pull-local-lab.html">Lab: Publish Edge Images on Remote OSTree Repositories</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-publish/s4-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Test Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s1-boot.html">Developer Testing of Edge Images</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="s2-boot-lab.html">Lab: Boot Edge VMs from Remote OSTree Repostories</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s3-installer-lab.html">Lab: Boot Edge VMs from Edge Installer Images OSTree</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch4-update/index.html">Update Edge Devices with New Operating System Images</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch4-update/s1-deltas.html">Apply, and Rollback Updates to Edge Devices</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Building Red Hat Device Edge Images</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Building Red Hat Device Edge Images</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Building Red Hat Device Edge Images</a></li>
    <li><a href="index.html">Test Operating System Images for Edge Devices</a></li>
    <li><a href="s2-boot-lab.html">Lab: Boot Edge VMs from Remote OSTree Repostories</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Boot Edge VMs from Remote OSTree Repostories</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Estimated reading time: <strong>5 minutes</strong>.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Objective</dt>
<dd>
<p>Boot a test VM from an OSTree commit in a remote OSTree repository.</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Work In Progress
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_you_begin"><a class="anchor" href="#_before_you_begin"></a>Before you Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need a development machine with RHEL and configured with the Image Builder service, its CLI and web UI, and a user that is member of the <code>weldr</code> group. Make sure your test machine was configured and verified by following the instructions from the <a href="../ch1-build/s4-install-lab.html" class="xref page">first lab</a>.</p>
</div>
<div class="paragraph">
<p>You need a second machine to run a web server that serves OSTree repositories. Make sure that machine was configured and verified by following the instructions from <a href="../ch2-publish/s2-ostree-lab.html" class="xref page">a previous lab</a>.</p>
</div>
<div class="paragraph">
<p>These instructions were tested on RHEL 9.4 [tentative!] but should work with minimal or no change on and newer and older RHEL 9.x releases.</p>
</div>
<div class="paragraph">
<p>If you are using the course classroom, you will log in on the <code>workstation</code> VM as the user <code>student</code> with password <code>student</code>, and you start SSH sessions to the <code>servera</code> VM from the same user. If not, please adapt the instructions to your test environment.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instructions"><a class="anchor" href="#_instructions"></a>Instructions</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On your test machine, verify that you have the prerequisites from previous labs.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Verify that the Image Builder service is active and that the current Linux user can submit requests to it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli status show</strong>
API server status:
    Database version:   0
    Database supported: true
    Schema version:     0
    API version:        1
    Backend:            osbuild-composer
    Build:              NEVRA:osbuild-composer-76-2.el9_2.x86_64
...</code></pre>
</div>
</div>
</li>
<li>
<p>Check that a remote client can access the OSTree repository in the web server machine.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com/repo/config</strong>
[core]
repo_version=1
mode=archive-z2</code></pre>
</div>
</div>
</li>
<li>
<p>Check that you can get the current commit ID the OSTree branch with the httpd edge system image that you created in <a href="../ch2-publish/s2-ostree-lab.html" class="xref page">a previous lab</a>. Your will get a different ID:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com/repo/refs/heads/rhel/9/x86_64/edge</strong>
4afeda6a96ec8b2c263b6965a9c3f92db1db2436ae1e1233da70b7776fc6137b</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Install the libvirtd tools and its Cockpit module.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Install the "Virtualization Host" package group to get the libvirtd, KVM, and Qemu daemons and tools.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo dnf group install -y "Virtualization Host"</strong>
...
Complete!
$ <strong>dnf install -y cockpit-machines</strong>
...
Complete!</code></pre>
</div>
</div>
</li>
<li>
<p>Grant an unprivileged user with permission to create and manage KVM/Qemu virtual machines (VMs).</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo groupmod libvirt -a -U student</strong></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Create and publish a kickstart file which points to the OSTree repository on the web server.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Using your preferred text editor, create a file named <code>rhel9-httpd.ks</code> with the following contents:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">lang en_US.UTF-8
keyboard us
timezone Etc/UTC --utc
text

zerombr
clearpart --all --initlabel
autopart --type=plain
rootpw --lock
user --name=core --group=wheel --password=redhat123

reboot

network --bootproto=dhcp
ostreesetup --nogpg --osname=rhel --remote=edge --url=http://servera.lab.example.com/repo/ --ref=rhel/9/x86_64/edge</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also downlod the <a href="https://github.com/RedHatQuickCourses/rhde-build-samples/blob/main/ks/rhel9-httpd.ks">kickstart file</a> from sample applications repository in GitHub.</p>
</div>
<div class="paragraph">
<p>Most lines on that kickstart file can be changed according to your needs, and real-world deployments would include items such as SSH keys for remote management. The important piece is the <code>ostreesetup</code> command, which directs Anaconda to download the latest commit from a remote OSTree repository using HTTP.</p>
</div>
</li>
<li>
<p>Copy the Kickstart file to your home directory on the web server machine.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>scp rhel9-httpd.ks servera.lab.example.com:~</strong>
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Switch to your web sever machine and publish the kickstart file and the OSTree commit in the web server content directory.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Copy the kickstart file to the web server content directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ls -1</strong>
<em>575d8ddc-2902-4de3-a0d5-82f5f194f5d8</em>-commit.tar
rhel9-httpd.ks
$ <strong>sudo cp rhel9-httpd.ks /var/ww/html</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Ensure that the kickstart file is acessible to the <code>apache</code> user and have correct SELinux labels.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ls -lZ /var/www/html</strong>
total 5
drwxr-xr-x. 7 root root unconfined_u:object_r:httpd_sys_content_t:s0 102 Sep  6 18:07 repo
-rw-r--r--. 1 root root unconfined_u:object_r:httpd_sys_content_t:s0 317 Sep  6 18:07 rhel9-httpd.ks</code></pre>
</div>
</div>
</li>
<li>
<p>If you need, change file permissions and SELinux labels.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo chmod -R a+X /var/www/html</strong>
$ <strong>sudo restorecon -R /var/www/html</strong></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Back to your development machine, verify that a remote client can access the kickstart file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com/rhel9-httpd.ks</strong>
lang en_US.UTF-8
keyboard us
timezone Etc/UTC --isUtc
...</code></pre>
</div>
</div>
</li>
<li>
<p>Create a RHEL VM which boots from the RHEL installation ISO and fetches an edge commit image from a web server.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Download the standard RHEL installation ISO from the customer portal, or grab a copy in the classroom environment at [ADD LINK]. Ensure you have a complete and consistent ISO in the <code>/home/student/Downloads/rhel-9.4-x86_64-boot.iso</code> file before proceeding.</p>
</li>
<li>
<p>Create a local VM, with a serial console, which uses the kickstart file from previous steps. Usign a serial console makes it easy to capture installation and boot messages for troubleshooting.</p>
<div class="paragraph">
<p>The following is a long command, it is broken into multiple lines for readability.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>virt-install --name edge-test-1 --os-variant rhel9.2 \
--memory 4096 --vcpus 2 --disk size=40 --graphics=none \
--location /home/student/Downloads/rhel-9.4-x86_64-boot.iso \
--extra-arg inst.ks=http://servera.lab.example.com/rhel9-httpd.ks \
--extra-arg console=ttyS0 -v</strong></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You must use <code>--location</code> instead of <code>--cdrom</code> to be able pass kernel arguments with <code>--extra-args</code>. Else you will be required to use the Grub menu, interactively, to add a reference to the kickstart file.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Wait until the installation finishes and you get a login prompt on the VM. It is expected that the VM reboots once during its installation. Log in as user <code>core</code> with password <code>redhat123</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Edge login:</code></pre>
</div>
</div>
</li>
<li>
<p>If the VM creation fails, and you must try again, stop and remove the VM before retrying the previous step.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>virsh destroy edge-test-1</strong>
Domain 'edge-test-1' destroyed
$ <strong>virsh undefine edge-test-1</strong>
Domain 'edge-test-1' has been undefined</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>[ Add steps to check the local VM, its local OSTree repo, commit, remote, and deployed commit? ]</p>
</div>
<div class="paragraph">
<p>You can leave that VM running, or stop it and restart in a future lab, when we apply updates to edge images.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps"><a class="anchor" href="#_next_steps"></a>Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The next activity builds an edge installer image and boots another local VM from it, demonstrating another method to provision edge devices.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="s1-boot.html">Developer Testing of Edge Images</a></span>
  <span class="next"><a href="s3-installer-lab.html">Lab: Boot Edge VMs from Edge Installer Images OSTree</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
