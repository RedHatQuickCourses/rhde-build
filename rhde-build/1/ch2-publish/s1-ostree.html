<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Introduction to OSTree Technology :: Building Red Hat Device Edge Images</title>
    <link rel="prev" href="index.html">
    <link rel="next" href="s2-ostree-lab.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Building Red Hat Device Edge Images</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/rhde-build/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="rhde-build" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Building Red Hat Device Edge Images</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch1-build/index.html">Build Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s1-devices.html">Introduction to Red Hat Device Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s2-devices-quiz.html">Quiz: Use Cases for Edge Devices and RHEL for Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s3-images.html">Design, Build, and Publish Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s4-install-lab.html">Lab: Install Image Builder on a Development VM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s5-blueprint.html">Create and Manage Blueprints for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s6-blueprint-lab.html">Lab: Create and Manage Blueprints for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s7-compose.html">Create Edge Images as Image Builder Composes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s8-compose-lab.html">Lab: Create and Manage Composes for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s9-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Publish Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="s1-ostree.html">Introduction to OSTree Technology</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s2-ostree-lab.html">Lab: Create a Remote OSTree Repository</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s3-pull-local-lab.html">Lab: Publish Edge Images on Remote OSTree Repositories</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch3-test/index.html">Test Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s1-boot.html">Developer Testing of Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s2-boot-lab.html">Lab: Boot Edge VMs from Remote OSTree Repostories</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s3-installer-lab.html">Lab: Boot Edge VMs from Edge Installer Images OSTree</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch4-update/index.html">Update Edge Devices with New Operating System Images</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch4-update/s1-deltas.html">Apply, and Rollback Updates to Edge Devices</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Building Red Hat Device Edge Images</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Building Red Hat Device Edge Images</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Building Red Hat Device Edge Images</a></li>
    <li><a href="index.html">Publish Operating System Images for Edge Devices</a></li>
    <li><a href="s1-ostree.html">Introduction to OSTree Technology</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Introduction to OSTree Technology</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Estimated reading time: <strong>5 minutes</strong>.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Objective</dt>
<dd>
<p>Understand how OSTree repositories represent operating system images</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Work In Progress
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ostree_commits_and_edge_images"><a class="anchor" href="#_ostree_commits_and_edge_images"></a>OSTree Commits and Edge Images</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Publishing an OSTree commit on a remote OSTree repository is the final step before you can provision edge systems.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/s1-ostree-fig1.svg" alt="s1 ostree fig1">
</div>
<div class="title">Figure 1. OSTree commits in an edge device installation and update workflow</div>
</div>
<div class="paragraph">
<p>The contents of an edge commit image produced by the Image Builder is a single OSTree commit, packaged as a TAR archice. That OSTree commit is, by itself, a valid as an OSTree repository, but it will likely be published in a larger OSTree repository, which contains multiple edge images and multiple versions of each edtge image.</p>
</div>
<div class="paragraph">
<p>The RPM-OSTree technology is used by the Image Builder service to build OSTree commits and is also the technology used by edge devices to download and apply system updates. But RPM-OSTree does not provide capabilities for OSTree repository management, which is the focus of this section.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_file_system_layout_of_edge_images"><a class="anchor" href="#_file_system_layout_of_edge_images"></a>File System Layout of Edge Images</h2>
<div class="sectionbody">
<div class="paragraph">
<p>[ Move most of this heading to somewhere else, as we can only see this after we provision an edge system? ]</p>
</div>
<div class="paragraph">
<p>[ We need to mention the three-way merge of /etc as part of ostree commit deployment, and then we need something here about file system layout ]</p>
</div>
<div class="paragraph">
<p>RPM-OSTree configures the root filesystem as read-only, as required by its underlying OSTree technology. Well, not the true root file system, it&#8217;s actually a chroot, but you learn those details later in this course. In an OSTree-based system, you cannot change a system file, not even as root, except by deploying a new system image an rebooting into the new image.</p>
</div>
<div class="paragraph">
<p>OSTree keeps multiple system images side-by-side in a system, and only switches from the current to the new system image with a reboot&#8201;&#8212;&#8201;constrast that with RPM package updates, which alter files which are in use by running processes and may produce unpredictable results.</p>
</div>
<div class="paragraph">
<p>You can reboot an RPM-OSTree system into any of the available system images, making it trivial to rollback a system update to a previous known good image&#8201;&#8212;&#8201;constrast that with rolling back an update of multiple RPM packages. With package-based systems, you can select an older kernel at boot, but you cannot easily revert all system binaries and dependency libraries, which depend on the kernel version.</p>
</div>
<div class="paragraph">
<p>RPM-OSTree allows writes to only <code>/etc</code> and <code>/var</code>, which are treated in different ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Files in <code>/var</code> are only touched at first boot, when they&#8217;re copied from the system image to the writable file system, but updates keep the contents in <code>/var</code> unchanged.</p>
</li>
<li>
<p>Files in <code>/etc</code> are updated with a three-way merge process: the current <code>/etc</code> contents are compared with the original system image, differences are applied a copy of the contents of <code>/etc</code> from the new system image, and the result saved to the writable file system.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The goal is, on one side, to preserve application data in <code>/var</code> across system updates, while enabling applications to include initial data in a system image; and on the other side, enable new system images to bring new configuration files and change configuration defaults, while preserving local customizations applied to the running system.</p>
</div>
<div class="paragraph">
<p>You are not allowed to define a detailed filesystem layout, with multiple mount points for different disk devices, in an RPM-OSTree system. It requires complete control over all system binaries in <code>/</code>, system configurations in <code>/etc</code>, and application or system data in <code>/var</code>. The file system customizations of Image Builder blueprints are not allowed for edge compose types.</p>
</div>
<div class="paragraph">
<p>RPM-OSTree also enables activating a write file system layer over <code>/</code> for local customizations, for example to install aditional RPM packages not included in the system image. It is not expected that edge systems abuse that feature of RPM-OSTreem but it can be handy during development and troubleshooting of edge images.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ostree_repositories"><a class="anchor" href="#_ostree_repositories"></a>OSTree Repositories</h2>
<div class="sectionbody">
<div class="paragraph">
<p>OSTree is, conceptually, very similar to Git: both are designed to manage the state of file trees as atomic units, providing transactional management, that is updates and rollbacks, of those trees. Both are designed to manage multiple concurrent branches and to be efficient on both disk space and network bandwidth when handling deltas between two states (or two commits) of the same file tree.</p>
</div>
<div class="paragraph">
<p>With RPM-OSTree, each branch of an OSTree repository is a system image. Updating an image means updating a branch. If you store, in the same OSTree repository, multiple system images based on the same RHEL release, each image adding a different set of applications and configurations file, those images share the same files for the Linux kernel, system binaries, and system libraries, for efficient use of disk space.</p>
</div>
<div class="paragraph">
<p>On the other side, each branch could be updated, at different times, to different RHEL releases, or receive updates to a different set of packages from RHEL. OSTree branches are not required to share files, but will not store duplicate files. Users of an OSTree repository do not need to be aware of the banches from other users: deduplication of files happen automatically.</p>
</div>
<div class="paragraph">
<p>If OSTree and Git are so similar, Why not just using Git? OSTree adds the following features, which are required to manage bootable Linux file systems but are not needed to manage application source code:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Recording SELinux labels and POSIX extended attributes</p>
</li>
<li>
<p>Installing booloaders, Linux Kernels, and initial ramdisks</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Similar to Git, a client OSTree system, such as an RPM-OSTree system, contains a copy (or a clone) of a remote OSTree repository, and it can pull changes from the remote repository. Unlike Git, OSTree is optimized for handling large binary files, as opposed to small text files with Git.</p>
</div>
<div class="paragraph">
<p>Another practical difference between OSTree and Git is the fact that OSTree provides no specialized server software: OSTree repositories are just files serverd by a standard HTTP server. You manage OSTree repositories using local file system access, and remote access over HTTP only works for downloading (pulling) updates from a remote repository to a local repository.</p>
</div>
<div class="paragraph">
<p>While this means that managing remote OSTree repositories requires more effort than with Git, it also means you don&#8217;t need to learn how to deploy and manage special server software: you just need to learn how to use the client-side OSTree tools.</p>
</div>
<div class="paragraph">
<p>The OSTree technology is not just part of RPM-OSTree and RHEL for Edge. It is a core technology of many inovative community projects, such as <a href="https://fedoraproject.org/iot/">Fedora IoT</a> and <a href="https://flatpak.org/">Flatpack</a>. It is also a core techology of <a href="https://docs.openshift.com/container-platform/4.16/architecture/architecture-rhcos.html">RHEL CoreOS</a> which powers cluster nodes of Red Hat OpenShift 4.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ostree_deployments"><a class="anchor" href="#_ostree_deployments"></a>OSTree Deployments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An edge device contains a local OSTree repository, which could contain multiple OSTree commits, but only one of those commits is active, or <strong>deployed</strong>. The deployed commit is similar to the active branch of a Git repository: you see its files in the system as regular files.</p>
</div>
<div class="paragraph">
<p>An edge device can pull additional commits from a remote OSTree repository, and that&#8217;s how it gets system updates. You can switch to, or deploy, a different OSTree commit present in the local OSTree repository of the device, which requires a reboot and performs the tree-way merge of <code>/etc</code>. The process is basically the same for applying updates or rolling back them.</p>
</div>
<div class="paragraph">
<p>Deploying an OSTree commit with RPM-OSTree also installs the boot loader, kernel, and initrd from commit.</p>
</div>
<div class="paragraph">
<p>When provisioning an edge system, OSTree deployment can happen in different moments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At installation time, when using the standard RHEL installation media: the standard RHEL installer pulls an OSTree commit from a remote OSTree repository, copies it to the system boot disk, and deploys the commit;</p>
</li>
<li>
<p>At at installation, when using an edge installer image: the standard RHEL installer copies an OSTree commit from the installation media itself, copies it to the system boot disk, and deploys the commit.</p>
</li>
<li>
<p>At image build time, when using a simplified edge installer image: the simplified edge installer image contains a raw system image which an OSTree commit already deployed, and just copies that raw system image to the system boot disk, then it installs the boot loader, kernel, and initrd from the raw system image.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once a system is booted into an OSTree deployment, you can pull updates, as a new OSTree commit, from a remote OSTree repository to its local OSTree repository branch and deploy that new OSTree commit. The update process, which we see in details later in this course, does not depend on how the system was initially provisioned.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_ostree_tooling"><a class="anchor" href="#_the_ostree_tooling"></a>The OSTree tooling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You must perform OSTree repository management from the command line, using the <code>ostree</code> command. Most of the OSTree commands are single-level, and each subcommand takes their own options and arguments, as in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">ostree <em>command</em> [<em>options</em>] [<em>arguments</em>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, the following command lists the commit history in a branch named <code>rhel/9/x86_64/edge</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree log rhel/9/x86_64/edge</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ostree</code> command defaults to using the system OSTree repository at <code>/sysroot/ostree/repo</code>, which is the local repository of an RHEL for Edge system. In a development machine, such as the one where you run the Image Builder service, or in a web server which hosts remote OSTree repositories for edge devices, you must include the --repo option to specify the path to your OSTree repository, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree --repo=<em>/path/to/my_repo</em> log rhel/9/x86_64/edge</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>A few commands, such as <code>ostree admin</code> have their own subcommands. For example, the following command shows the differences between the current configuration directory (<code>/etc</code>) in a live system and its OSTree commit, effectively showing what was changed after the commit was deployed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree admin config-diff</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>At any level, you can use the <code>--help</code> option to display on-line help for the available command, subcommands, options, and arguments. All the following are valid examples of getting online help from the <code>ostree</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree --help</strong>
$ <strong>ostree log --help</strong>
$ <strong>ostree admin --help</strong>
$ <strong>ostree admin config-diff --help</strong></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps"><a class="anchor" href="#_next_steps"></a>Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that you was introduced to the essential concepts of OSTree repositories, a series of hands-on activties install and configure a web server to host remote OSTree repositories and publish simple edge images on that web server. Later in this course you will test those edge images using local VMs, and them update those VMs to use new system images.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="index.html">Publish Operating System Images for Edge Devices</a></span>
  <span class="next"><a href="s2-ostree-lab.html">Lab: Create a Remote OSTree Repository</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
