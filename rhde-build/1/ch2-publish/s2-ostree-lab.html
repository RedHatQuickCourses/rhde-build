<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Publish Edge Images on Remote OSTree Repositories :: Building Red Hat Device Edge Images</title>
    <link rel="prev" href="s1-ostree.html">
    <link rel="next" href="../ch3-test/index.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Building Red Hat Device Edge Images</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/rhde-build/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="rhde-build" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Building Red Hat Device Edge Images</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch1-build/index.html">Build Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s1-devices.html">Introduction to Red Hat Device Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch1-build/s2-devices-quiz.html">Quiz: Use Cases for Edge Devices and RHEL for Edge</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../ch1-build/s2-devices-quiz-answers.html">Answers to the Quiz</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s3-images.html">Design, Build, and Publish Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s4-install-lab.html">Lab: Install Image Builder on a Development VM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s5-blueprint.html">Create and Manage Blueprints for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s6-blueprint-lab.html">Lab: Create and Manage Blueprints for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s7-compose.html">Create Edge Images as Image Builder Composes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s8-compose-lab.html">Lab: Create and Manage Composes for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-build/s9-summary.html">Summary</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Publish Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s1-ostree.html">Introduction to OSTree Technology</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="s2-ostree-lab.html">Lab: Publish Edge Images on Remote OSTree Repositories</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch3-test/index.html">Validate initial deployment of RHEL for Edge images in local VMs using virsh and cockpit</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch3-test/s2-boot-lab.html">Lab: Boot Edge VMs from Remote OSTree Repostories</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Building Red Hat Device Edge Images</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Building Red Hat Device Edge Images</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Building Red Hat Device Edge Images</a></li>
    <li><a href="index.html">Publish Operating System Images for Edge Devices</a></li>
    <li><a href="s2-ostree-lab.html">Lab: Publish Edge Images on Remote OSTree Repositories</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Publish Edge Images on Remote OSTree Repositories</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Estimated reading time: <strong>5 minutes</strong>.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Objective</dt>
<dd>
<p>Publish an Image Builder edge commit image in a remote HTTP server so it is available to edge devices.</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Work In Progress
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_you_begin"><a class="anchor" href="#_before_you_begin"></a>Before you Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need a RHEL machine configured with the Image Builder service, its CLI and web UI, and a user that is member of the <code>weldr</code> group. Make sure your test machine was configured and verified by following the instructions from the <a href="#s4-install-lab.adoc" class="xref unresolved">first lab</a>.</p>
</div>
<div class="paragraph">
<p>You need a second machine to run a web server, to which you have unrestricted sudo access to install packages and configure system services.</p>
</div>
<div class="paragraph">
<p>You could run the web server in the same machine you use to run the Image Builder service, and that would match development and CI/CD environments, but production environments usually require a dedicated and hardened server acessible to remote edge devices in multiple locations.</p>
</div>
<div class="paragraph">
<p>You also need the edge commit image that was created and downloaded to your user home directory by the <a href="#s6-compose-lab.adoc" class="xref unresolved">previous lab</a>.</p>
</div>
<div class="paragraph">
<p>These instructions were tested on RHEL 9.4 [tentative!] but should work with minimal or no change on and newer and older RHEL 9.x releases.</p>
</div>
<div class="paragraph">
<p>If you are using the course classroom, you will log in on the <code>workstation</code> VM as the user <code>student</code> with password <code>student</code>, and you start SSH sessions to the <code>servera</code> VM from the same user. If not, please adapt the instructions to your test environment.</p>
</div>
<div class="paragraph">
<p>[ rename "test machine" everywhere to "developement manchine"? It&#8217;s not like real "developers" would use image builder ]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instructions"><a class="anchor" href="#_instructions"></a>Instructions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>[ could use a worflow diagram of the entire process, which spans multiple labs (and chapters!) ]</p>
</div>
<div class="paragraph">
<p>[ switch everyhere to use the hostname in the prompt? ]</p>
</div>
<div class="paragraph">
<p>[ have the user created on the blueprint instead of by kickstart? use a name other than "core", and comment about SSH keys ]</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On your test machine, verify that you have the prerequisites from previous labs.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Verify that the Image Builder service is active and that the current Linux user can submit requests to it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli status show</strong>
API server status:
    Database version:   0
    Database supported: true
    Schema version:     0
    API version:        1
    Backend:            osbuild-composer
    Build:              NEVRA:osbuild-composer-76-2.el9_2.x86_64
...</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that you have a tar file named <code><em>uuid</em>-compose.tar</code> that contains the edge commit image from the <a href="#s6-compose-lab.adoc" class="xref unresolved">previous lab</a>. Its file name will be different from the following output because Image Builder generates new UUIDs for every compose.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ls *commit.tar</strong>
<em>575d8ddc-2902-4de3-a0d5-82f5f194f5d8</em>-commit.tar</code></pre>
</div>
</div>
</li>
<li>
<p>To ease the following steps, copy and paste the UUID from the file name to a shell variable.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>UUID=<em>575d8ddc-2902-4de3-a0d5-82f5f194f5d8</em></strong></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On your web server machine, configure a web server dedicated to providing OSTree repositories.</p>
<div class="paragraph">
<p>The instructions bellow confingure an Apache Web Server as a system service on the <code>servera</code> machine. You could use the NGinx web server and run the web server as a container, among other variations.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Production deployments usually require further customization, such as enabling TLS connections, using trusted certificates, and requiring authentication, which are not performed here.
</td>
</tr>
</table>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>On another terminal, start an SSH session on your web server machine (<code>servera</code>), and copy the shell variable from the first terminal.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ssh servera</strong>
$ <strong>UUID=<em>575d8ddc-2902-4de3-a0d5-82f5f194f5d8</em></strong></code></pre>
</div>
</div>
</li>
<li>
<p>Install the Apache Web Server packages from RHEL.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo yum install -y httpd</strong>
...
Complete!</code></pre>
</div>
</div>
</li>
<li>
<p>Enable and start the Apache Web Server system service.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo systemctl enable httpd</strong>
Created symlink /etc/systemd/system/multi-user.target.wants/httpd.service → /usr/lib/systemd/system/httpd.service.
$ <strong>sudo systemctl start httpd</strong>
...</code></pre>
</div>
</div>
</li>
<li>
<p>Enable remote access to the Apache Web Server on the system&#8217;s firewall.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo firewall-cmd --add-service=http --permanent</strong>
success
$ <strong>sudo firewall-cmd --reload</strong>
success</code></pre>
</div>
</div>
</li>
<li>
<p>Install the RPM-OSTree and the lower level OSTree tooling on the web server machine, just in case you need to perform maintenance on the OSTree repositories you will store on it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo yum install -y rpm-ostree ostree</strong>
...
Complete!</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On your test machine, check that you have access to the web server machine and copy the edge commit image, generated in the <a href="#s6-compose-lab.adoc" class="xref unresolved">previous lab</a>, to the web server.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Use a web browser or any web client to access the default welcome page from the Apache Web Server.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com</strong>
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"&gt;

&lt;html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"&gt;
        &lt;head&gt;
                &lt;title&gt;Test Page for the HTTP Server on Red Hat Enterprise Linux&lt;/title&gt;
...</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the edge commit image to your home directory on the web server machine.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>scp $UUID-commit.tar servera.lab.example.com:~</strong>
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Still on your test manchine, create an Anacond Kickstart file that points to the OSTree repository on the web server.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Using your preferred text editor, create a file named <code>rhel9-httpd.ks</code> with the following contents:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">lang en_US.UTF-8
keyboard us
timezone Etc/UTC --utc
text

zerombr
clearpart --all --initlabel
autopart --type=plain
rootpw --lock
user --name=core --group=wheel --password=redhat123

reboot

network --bootproto=dhcp
ostreesetup --nogpg --osname=rhel --remote=edge --url=http://servera.lab.example.com/repo/ --ref=rhel/9/x86_64/edge</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also downlod the <a href="https://github.com/RedHatQuickCourses/rhde-build-samples/blob/main/ks/rhel9-httpd.ks">kickstart file</a> from sample applications repository in GitHub.</p>
</div>
<div class="paragraph">
<p>Most lines on that kickstart file can be changed according to needs, and real-world deployments would include items such as SSH keys for remote login and remote management. The important piece is the <code>ostreesetup</code> command, which directs Anaconda to download the latest commit from a remote OSTree repository using HTTP.</p>
</div>
</li>
<li>
<p>Copy the Kickstart file to your home directory on the web server machine.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>scp rhel9-httpd.ks servera.lab.example.com:~</strong>
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Switch to your web sever machine and publish the kickstart file and the OSTree commit in the web server content directory.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Copy the kickstart file to the web server content directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ls -1</strong>
<em>575d8ddc-2902-4de3-a0d5-82f5f194f5d8</em>-commit.tar
rhel9-httpd.ks
$ <strong>sudo cp rhel9-httpd.ks /var/ww/html</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Extract the OSTree commit to the web server content directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo tar xf ~/$UUID-commit.tar -C /var/www/html</strong></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Extracting an edge commit image only works for initializing a new OSTree repository with a single commit. If you must add multiple edge images to the same OSTree repository, or you need to add updates to an edge image, you must use the <code>ostree pull-local</code> command. This command will be presented in a later chapter of this course, when we teach how to publish and apply updates.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Ensure the OSTree repository contents are acessiblee to the <code>apache</code> user and have correct SELinux labels.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ls -lZ /var/www/html</strong>
total 5
-rw-r--r--. 1 root root unconfined_u:object_r:httpd_sys_content_t:s0 553 Sep  6 18:07 compose.json
drwxr-xr-x. 7 root root unconfined_u:object_r:httpd_sys_content_t:s0 102 Sep  6 18:07 repo
-rw-r--r--. 1 root root unconfined_u:object_r:httpd_sys_content_t:s0 317 Sep  6 18:07 rhel9-httpd.ks</code></pre>
</div>
</div>
</li>
<li>
<p>If you need, change file permissions and SELinux labels.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo chmod -R a+X /var/www/html</strong>
$ <strong>sudo restorecon -R /var/www/html</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Remove the compose metadata, because you do not need it to serve OSTree content.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo rm compose.json</strong></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Back to your test machine, verify that a remote client can access the kickstart file and the remote OSTree repository.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Check that a remote client can read the kickstart file over HTTP.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com/rhel9-httpd.ks</strong>
lang en_US.UTF-8
keyboard us
timezone Etc/UTC --isUtc
...</code></pre>
</div>
</div>
</li>
<li>
<p>Check that a remote client can read the OSTree repository configuration file. This way, you don&#8217;t need to setup a local OSTree repository just to check access to the remode repository.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com/repo/config</strong>
[core]
repo_version=1
mode=archive-z2</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>If you wish, you can now close the SSH connection to the web server machine and its terminal.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Conclusion statement.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps"><a class="anchor" href="#_next_steps"></a>Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before proceeding to test the edge image using a virtual machine, the next activity demonstates using Red Hat Ansible Automation Platform to automate building and publishing edge images.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="s1-ostree.html">Introduction to OSTree Technology</a></span>
  <span class="next"><a href="../ch3-test/index.html">Validate initial deployment of RHEL for Edge images in local VMs using virsh and cockpit</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
