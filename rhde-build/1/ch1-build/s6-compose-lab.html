<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Create and Manage Composes for Edge Images :: Building Red Hat Device Edge Images</title>
    <link rel="prev" href="s5-blueprint-lab.html">
    <link rel="next" href="s7-ostree-lab.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Building Red Hat Device Edge Images</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/rhde-build/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="rhde-build" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Building Red Hat Device Edge Images</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Build Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s1-devices.html">Introduction to Red Hat Device Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s3-images.html">Design, Build, and Publish Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s4-install-lab.html">Lab: Install Image Builder on a Development VM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s5-blueprint-lab.html">Lab: Create and Manage Blueprints for Edge Images</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="s6-compose-lab.html">Lab: Create and Manage Composes for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s7-ostree-lab.html">Lab: Publish Edge Images on Remote OSTree Repositories</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Building Red Hat Device Edge Images</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Building Red Hat Device Edge Images</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Building Red Hat Device Edge Images</a></li>
    <li><a href="index.html">Build Operating System Images for Edge Devices</a></li>
    <li><a href="s6-compose-lab.html">Lab: Create and Manage Composes for Edge Images</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Create and Manage Composes for Edge Images</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Estimated reading time: <strong>5 minutes</strong>.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Objective</dt>
<dd>
<p>Create and validate Image Builder composes for building edge images.</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Work In Progress
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_you_begin"><a class="anchor" href="#_before_you_begin"></a>Before you Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need a RHEL machine configured with the Image Builder service, its CLI and web UI, and a user that is member of the <code>weldr</code> group. Make sure your test machine was configured and verified by following the instructions from the <a href="s4-install-lab.html" class="xref page">first lab</a>.</p>
</div>
<div class="paragraph">
<p>You also need the blueprint that was created and uploaded to the Image Builder Service by the <a href="s5-blueprint-lab.html" class="xref page">previous lab</a>.</p>
</div>
<div class="paragraph">
<p>These instructions were tested on RHEL 9.4 [tentative!] but should work with minimal or no change on and newer and older RHEL 9.x releases.</p>
</div>
<div class="paragraph">
<p>If you are using the course classroom, you will log in on the <code>workstation</code> VM as the user <code>student</code> with password <code>student</code>. If not, please adapt the instructions to your test environment.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instructions"><a class="anchor" href="#_instructions"></a>Instructions</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Verify that you have the prerequisites from previous labs.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Verify that the Image Builder service is active and that the current Linux user can submit requests to it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli status show</strong>
API server status:
    Database version:   0
    Database supported: true
    Schema version:     0
    API version:        1
    Backend:            osbuild-composer
    Build:              NEVRA:osbuild-composer-76-2.el9_2.x86_64
...</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that your Image Builder service has a blueprint named <code>rhe9-edge</code> that includes the <code>httpd</code> package, from the <a href="s5-blueprint-lab.html" class="xref page">previous lab</a>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli blueprint show rhel9-edge</strong>
...
<strong>[[packages]]
name = "httpd"</strong>
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Build an OSTree commit from the blueprint, but cancel it before its finished.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Start an OSTree compose from the bueprint.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose start-ostree rhel9-edge edge-commit</strong>
Compose 01f3796b-85fd-4383-bbe8-eefc9550acdc added to the queue</code></pre>
</div>
</div>
</li>
<li>
<p>To ease the following steps, copy and paste the UUID from the previous command output to a shell variable.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>UUID=<em>01f3796b-85fd-4383-bbe8-eefc9550acdc</em></strong></code></pre>
</div>
</div>
</li>
<li>
<p>While the Image Builder service builds the image, its compose will show a status of <code>RUNNING</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose list</strong>
ID                                     Status    Blueprint    Version   Type
01f3796b-85fd-4383-bbe8-eefc9550acdc   RUNNING   rhel9-edge   0.0.1     edge-commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>If your Image Builder service has many composes, you can filter the listing by appending <code>finished</code> or <code>running</code> to the <code>compose list</code> command.</p>
</div>
</li>
<li>
<p>Before a compose finishes running, you can cancel it:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose cancel $UUID</strong>
$ <strong>composer-cli compose list</strong>
ID                                     Status     Blueprint    Version   Type
01f3796b-85fd-4383-bbe8-eefc9550acdc   FAILED     rhel9-edge   0.0.1     edge-commit</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you took too long to cancel the compose, you can start another one and cancel it. Or just move forward, because you won&#8217;t need that canceled compose for the remaining of this activity and this course.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Build another OSTree commit from the same blueprint, but this time let it finish.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Start a new OSTree compose from the bueprint.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose start-ostree rhel9-edge edge-commit</strong>
Compose 575d8ddc-2902-4de3-a0d5-82f5f194f5d8 added to the queue</code></pre>
</div>
</div>
</li>
<li>
<p>Copy and paste the UUID from the previous command output to a shell variable, overriding its previous value.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>UUID=<em>575d8ddc-2902-4de3-a0d5-82f5f194f5d8</em></strong></code></pre>
</div>
</div>
</li>
<li>
<p>Repeat the command that list composes until you see that the latest changed its status to <code>FINISHED</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose list</strong>
ID                                     Status     Blueprint    Version   Type
01f3796b-85fd-4383-bbe8-eefc9550acdc   FAILED     rhel9-edge   0.0.1     edge-commit
575d8ddc-2902-4de3-a0d5-82f5f194f5d8   FINISHED   rhel9-edge   0.0.1     edge-commit</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Fetch metadata from the compose.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Get information such as requested and dependency packages from the compose.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>compose-cli info $UUID | less</strong>
575d8ddc-2902-4de3-a0d5-82f5f194f5d8 FINISHED rhel9-edge      0.0.1 edge-commit
Packages:
    httpd-
Modules:
Dependencies:
    ModemManager-1.20.2-1.el9.x86_64
    ModemManager-glib-1.20.2-1.el9.x86_64
    NetworkManager-1:1.42.2-1.el9.x86_64
...</code></pre>
</div>
</div>
</li>
<li>
<p>Get the build logs of the compose. There are many errors at the start of the log which are expected and can be ignored.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>compose-cli log $UUID | less</strong>
Pipeline build
Stage org.osbuild.rpm
Output:
/usr/lib/tmpfiles.d/colord.conf:1: Failed to resolve user 'colord': No such process
...
Failed to open file "/sys/fs/selinux/checkreqprot": Read-only file system
imported gpg key
imported gpg key
Verifying packages...
Preparing packages...
libgcc-11.3.1-4.3.el9.x86_64
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Download and verify the edge commit image from the latest compose.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Download the image to your home directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli compose image $UUID</strong>
575d8ddc-2902-4de3-a0d5-82f5f194f5d8-commit.tar</code></pre>
</div>
</div>
</li>
<li>
<p>Extract the image contents to a temporary directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>mkdir delete-me</strong>
$ <strong>tar xf $UUID-commit.tar -C delete-me</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Check that the <code>rpm-ostree</code> command can use the temporary directory as an OSTree repository and list RPM packages inside the image.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ rpm-ostree db list rhel/9/x86_64/edge --repo=delete-me/repo
ostree commit: rhel/9/x86_64/edge (4afeda6a96ec8b2c263b6965a9c3f92db1db2436ae1e1233da70b7776fc6137b)
 ModemManager-1.20.2-1.el9.x86_64
 ModemManager-glib-1.20.2-1.el9.x86_64
 NetworkManager-1:1.42.2-1.el9.x86_64
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>If you wish, you can perform additional integrity check of your edge commit image using the lower level OSTree tooling.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Get the commit ID from the compose metadata and store it in a shell variable. You will get a different ID than the one shown here.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>COMMIT=$(jq -r '.["ostree-commit"]' &lt; delete-me/compose.json)</strong>
$ <strong>echo $COMMIT</strong>
4afeda6a96ec8b2c263b6965a9c3f92db1db2436ae1e1233da70b7776fc6137b</code></pre>
</div>
</div>
<div class="paragraph">
<p>You would not need the commit ID for an OSTree repository with a single commit, as the one you got from your only edge commit image, but as you build more edge images, or update existing images, you will need to differentiate between multiple commits in the same OSTree repository.</p>
</div>
</li>
<li>
<p>Get the branch reference from the compose metadata and store it in a shell variable.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>REF=$(jq -r '.["ref"]' &lt; delete-me/compose.json)</strong>
$ <strong>echo $REF</strong>
rhel/9/x86_64/edge</code></pre>
</div>
</div>
<div class="paragraph">
<p>You would not need the branch reference for an OSTree repository with a single commit, as the one you got from your only edge commit image, but as you build more edge images, you will need to assign each a different branch name, so you can publish all of them on the same OSTree repository.</p>
</div>
</li>
<li>
<p>List the commits available on your OSTree repository. There should be only one commit which matches the compose metadata.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree --repo=delete-me/repo log $REF</strong>
commit 4afeda6a96ec8b2c263b6965a9c3f92db1db2436ae1e1233da70b7776fc6137b
ContentChecksum:  549eb067bbcfa59a90f1948e75702a34a857122a74d9936c062bc64349f24330
Date:  2024-09-06 22:07:45 +0000
Version: 9.2
(no subject)</code></pre>
</div>
</div>
</li>
<li>
<p>List the branches available on your OSTree repository. There should be only one branch which matches the compose metadata.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree --repo=delete-me/repo refs</strong>
rhel/9/x86_64/edge</code></pre>
</div>
</div>
</li>
<li>
<p>Peform an integrity check in the OSTree repository.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ostree --repo=delete-me/repo fsck</strong>
Validating refs...
Validating refs in collections...
Enumerating commits...
Verifying content integrity of 1 commit objects...
fsck objects (28670/28670) [=============] 100%
object fsck of 1 commits completed successfully - no errors found.</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>You can now delete the temporary directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>rm -rf delete-me</strong></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now you know the basics of managing composes and building images with the Image Builder service.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps"><a class="anchor" href="#_next_steps"></a>Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The next activity pushes the edge commit image to an OSTree repository, making it available to edge systems.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="s5-blueprint-lab.html">Lab: Create and Manage Blueprints for Edge Images</a></span>
  <span class="next"><a href="s7-ostree-lab.html">Lab: Publish Edge Images on Remote OSTree Repositories</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
