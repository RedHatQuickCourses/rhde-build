<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Publish Edge Images on Remote OSTree Repositories :: Building Red Hat Device Edge Images</title>
    <link rel="prev" href="s6-compose-lab.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Building Red Hat Device Edge Images</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/rhde-build/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="rhde-build" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Building Red Hat Device Edge Images</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Build Operating System Images for Edge Devices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s1-devices.html">Introduction to Red Hat Device Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s3-images.html">Design, Build, and Publish Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s4-install-lab.html">Lab: Install Image Builder on a Development VM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s5-blueprint-lab.html">Lab: Create and Manage Blueprints for Edge Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s6-compose-lab.html">Lab: Create and Manage Composes for Edge Images</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="s7-ostree-lab.html">Lab: Publish Edge Images on Remote OSTree Repositories</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Building Red Hat Device Edge Images</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Building Red Hat Device Edge Images</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Building Red Hat Device Edge Images</a></li>
    <li><a href="index.html">Build Operating System Images for Edge Devices</a></li>
    <li><a href="s7-ostree-lab.html">Lab: Publish Edge Images on Remote OSTree Repositories</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Publish Edge Images on Remote OSTree Repositories</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Estimated reading time: <strong>5 minutes</strong>.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Objective</dt>
<dd>
<p>Publish an Image Builder edge commit image in a remote HTTP server so it is available to edge devices.</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Work In Progress
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_you_begin"><a class="anchor" href="#_before_you_begin"></a>Before you Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need a RHEL machine configured with the Image Builder service, its CLI and web UI, and a user that is member of the <code>weldr</code> group. Make sure your test machine was configured and verified by following the instructions from the <a href="#s3-install-lab.adoc" class="xref unresolved">first lab</a>.</p>
</div>
<div class="paragraph">
<p>You need a second machine to run a web server, to which you have unrestricted sudo access to install packages and configure system services.</p>
</div>
<div class="paragraph">
<p>You could use the same machine you use to run the Image Builder service, and that would match development and CI/CD environments, but production environments usually require a dedicated and hardneed server acessible to remote edge devices in multiple locations.</p>
</div>
<div class="paragraph">
<p>You also need the edge commit image that was created and downloaded to your user home directory by the <a href="#s5-compose-lab.adoc" class="xref unresolved">previous lab</a>.</p>
</div>
<div class="paragraph">
<p>These instructions were tested on RHEL 9.4 [tentative!] but should work with minimal or no change on and newer and older RHEL 9.x releases.</p>
</div>
<div class="paragraph">
<p>If you are using the course classroom, you will log in on the <code>workstation</code> VM as the user <code>student</code> with password <code>student</code>, and you start SSH sessions to the <code>servera</code> VM from the same user. If not, please adapt the instructions to your test environment.</p>
</div>
<div class="paragraph">
<p>[ rename "test machine" everywhere to "developer manchine"? It&#8217;s not like real "developers" would use image builder ]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instructions"><a class="anchor" href="#_instructions"></a>Instructions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>[ could use a worflow diagram of the entire process, which spans multiple labs (and chapters!) ]</p>
</div>
<div class="paragraph">
<p>[ switch everyhere to use the hostname in the prompt? ]</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On your test machine, verify that you have the prerequisites from previous labs.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Verify that the Image Builder service is active and that the current Linux user can submit requests to it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>composer-cli status show</strong>
API server status:
    Database version:   0
    Database supported: true
    Schema version:     0
    API version:        1
    Backend:            osbuild-composer
    Build:              NEVRA:osbuild-composer-76-2.el9_2.x86_64
...</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that you have a tar file named <code><em>uuid</em>-compose.tar</code> that contains an OSTree commit. Its file name will be different from the following output because Image Builder generates new UUIDs for every compose.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ls \*commit.tar</strong>
<em>01f3796b-85fd-4383-bbe8-eefc9550acdc</em>-commit.tar</code></pre>
</div>
</div>
</li>
<li>
<p>To ease the following steps, copy and paste the UUID from the file name to a shell variable.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>UUID=<em>01f3796b-85fd-4383-bbe8-eefc9550acdc</em></strong></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On your web server machine, configure a web server dedicated to providing OSTree repositories.</p>
<div class="paragraph">
<p>The instructions bellow confingure an Apache Web Server as a system service on the <code>servera</code> machine. You could use the NGinx web server and run the web server as a container, among other variations. Production deployments might require further customization, such as enabling TLS connections, using trusted certificates, and requiring authentication, which are not inclided here.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>On another terminal, start an SSH session on your web server machine (<code>servera</code>), and copy the shell variable from the first terminal.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ssh servera</strong>
$ <strong>UUID=<em>01f3796b-85fd-4383-bbe8-eefc9550acdc</em></strong></code></pre>
</div>
</div>
</li>
<li>
<p>Install the Apache Web Server packages from RHEL.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo yum install -y httpd</strong>
...
Complete!</code></pre>
</div>
</div>
</li>
<li>
<p>Enable and start the Apache Web Server system service.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo systemctl enable httpd</strong>
Created symlink /etc/systemd/system/multi-user.target.wants/httpd.service → /usr/lib/systemd/system/httpd.service.
$ <strong>sudo systemctl start httpd</strong>
...</code></pre>
</div>
</div>
</li>
<li>
<p>Enable remote access to the Apache Web Server on the system&#8217;s firewall.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo firewall-cmd --add-service=http --permanent</strong>
success
$ <strong>sudo firewall-cmd --reload</strong>
success</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On your test machine, check that you have access to the web server machine and copy the edge commit image, generated in a previous lab, to the web server.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Use a web browser or any web client to access the default welcome page from the Apache Web Server.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com</strong>
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"&gt;

&lt;html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"&gt;
        &lt;head&gt;
                &lt;title&gt;Test Page for the HTTP Server on Red Hat Enterprise Linux&lt;/title&gt;
...</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the edge commit image to your home directory on the web server machine.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>scp $UUID-commit.tar servera.lab.example.com:~</strong>
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On your web sever machine, publish the OSTree commit in the web server content directory.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Extract the OSTree commit in the web server content directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ls $UUID-commit.tar</strong>
<em>01f3796b-85fd-4383-bbe8-eefc9550acdc</em>-commit.tar
$ <strong>cd /var/www/html</strong>
$ <strong>sudo tar xf ~/$UUID-commit.tar</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Ensure the OSTree repository contents are acessive to the <code>apache</code> user and have correct SELinux labels.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ls -lZ</strong>
total 4
-rw-r--r--. 1 root root unconfined_u:object_r:httpd_sys_content_t:s0 553 Sep  6 18:07 compose.json
drwxr-xr-x. 7 root root unconfined_u:object_r:httpd_sys_content_t:s0 102 Sep  6 18:07 repo</code></pre>
</div>
</div>
</li>
<li>
<p>If you need, change file permissions and SELinux labels. Or just delete the <code>repo</code> directory and extract the OSTree commit again.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo chmod -R a+X repo</strong>
$ <strong>sudo restorecon -R repo</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Remove the compose metadata, because you do not need it to server OSTree content.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo rm compose.json</strong></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>On your test machine, verify that a remote client can access a remote OSTree repository from the web server, by reading its repository configuration file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl http://servera.lab.example.com/repo/config</strong>
[core]
repo_version=1
mode=archive-z2</code></pre>
</div>
</div>
</li>
<li>
<p>If you wish, you can now close the SSH connection to the web server machine and its terminal. If you prefer to leave it open for future labs, please return do your home directory.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Conclusion statement.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps"><a class="anchor" href="#_next_steps"></a>Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before proceeding to test the edge image using a virtual machine, in the next chapter, the next activity demonstates using Red Hat Ansible Automation Platform to automate building and publishing edge images.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="s6-compose-lab.html">Lab: Create and Manage Composes for Edge Images</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
